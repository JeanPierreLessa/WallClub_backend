{% extends "portais/admin/base.html" %}
{% load static %}
{% load formatacao_tags %}

{% block title %}Lançamentos Manuais{% endblock %}

{% block extra_css %}
<!-- CSS específico da página -->
{% endblock %}

{% block navbar_actions %}
<button onclick="voltarTela()" class="btn btn-outline-light btn-sm">
    <i class="fas fa-arrow-left me-1"></i>
    Voltar
</button>
{% endblock %}

{% block content %}
<div class="page-header-compact">
    <div class="d-flex align-items-center">
        <i class="fas fa-hand-holding-usd me-2" style="color: var(--primary-color);"></i>
        <h1 class="mb-0">Lançamentos Manuais</h1>
    </div>
</div>

<!-- Mensagens -->
{% if messages %}
{% for message in messages %}
<div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
    {{ message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endfor %}
{% endif %}

<!-- Filtros -->
<div class="filters-top">
    <form method="GET" class="filters-form">
        <div class="form-group">
            <label for="nsu">NSU</label>
            <input type="text" name="nsu" id="nsu" value="{{ search_nsu }}" placeholder="Digite o NSU..."
                class="form-control">
        </div>
        <div class="form-group">
            <label for="data_inicio">Data Início</label>
            <input type="date" name="data_inicio" id="data_inicio" value="{{ search_data_inicio }}"
                class="form-control">
        </div>
        <div class="form-group">
            <label for="data_fim">Data Fim</label>
            <input type="date" name="data_fim" id="data_fim" value="{{ search_data_fim }}" class="form-control">
        </div>
        <div class="form-group">
            <label for="tipo_lancamento">Tipo</label>
            <select name="tipo_lancamento" id="tipo_lancamento" class="form-control">
                <option value="">Todos</option>
                {% for value, label in tipos_choices %}
                <option value="{{ value }}" {% if search_tipo == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="status">Status</label>
            <select name="status" id="status" class="form-control">
                <option value="">Todos</option>
                {% for value, label in status_choices %}
                <option value="{{ value }}" {% if search_status == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <button type="submit" class="btn btn-success btn-colorido">
                <i class="fas fa-search me-1"></i> Buscar
            </button>
            <a href="{% url 'portais_admin:lancamento_manual_form' %}" class="btn btn-primary btn-colorido ms-2">
                <i class="fas fa-plus me-1"></i> Novo Lançamento
            </a>
        </div>
    </form>
</div>

<!-- Mensagem de erro de parâmetros -->
{% if erro_parametros %}
<div class="container">
    <div class="alert alert-warning" role="alert">
        <h5><i class="fas fa-exclamation-triangle me-2"></i>Parâmetros obrigatórios</h5>
        <p>Para realizar a busca, é necessário informar pelo menos um dos critérios:</p>
        <ul>
            <li><strong>NSU</strong> - para buscar por número específico</li>
            <li><strong>Range de datas</strong> - data início E data fim</li>
        </ul>
        <p class="mb-0">Use os filtros acima para definir os critérios de busca.</p>
    </div>
</div>
{% endif %}

<!-- Tabela de dados -->
<div class="container">
    <div class="table-container">
        {% if page_obj %}
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nome da Loja</th>
                        <th>Tipo</th>
                        <th>Valor</th>
                        <th>Descrição</th>
                        <th>Status</th>
                        <th>Data Lançamento</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for lancamento in page_obj %}
                    <tr>
                        <td>{{ lancamento.id }}</td>
                        <td>{{ lancamento.loja_nome|default:lancamento.loja_id }}</td>
                        <td>
                            {% if lancamento.tipo_lancamento == 'C' %}
                            Crédito
                            {% else %}
                            Débito
                            {% endif %}
                        </td>
                        <td class="monetary">R$ {{ lancamento.valor|floatformat:2 }}</td>
                        <td>{{ lancamento.descricao|truncatechars:50 }}</td>
                        <td>
                            <select class="form-select form-select-sm status-select"
                                data-lancamento-id="{{ lancamento.id }}" data-status-original="{{ lancamento.status }}">
                                <option value="pendente" {% if lancamento.status == 'pendente' %}selected{% endif %}>
                                    Pendente</option>
                                <option value="processado" {% if lancamento.status == 'processado' %}selected{% endif %}>
                                    Processado</option>
                                <option value="cancelado" {% if lancamento.status == 'cancelado' %}selected{% endif %}>
                                    Cancelado</option>
                            </select>
                        </td>
                        <td>{{ lancamento.data_lancamento|date:"d/m/Y H:i" }}</td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <a href="{% url 'portais_admin:lancamento_manual_detail' lancamento.id %}"
                                    class="btn btn-outline-info" title="Ver detalhes">
                                    <i class="fas fa-eye"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% elif not erro_parametros %}
        <div class="no-data">
            <i class="fas fa-search" style="font-size: 48px; color: #ccc; margin-bottom: 10px;"></i>
            <p>Nenhum lançamento manual encontrado com os filtros aplicados.</p>
            <p>Tente ajustar os critérios de busca ou verificar se há dados disponíveis para o período selecionado.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Paginação -->
{% if page_obj.has_other_pages %}
<div class="pagination">
    <div class="pagination-controls">
        {% if page_obj.has_previous %}
        <a href="?page=1&{{ request.GET.urlencode }}">&laquo; Primeira</a>
        <a href="?page={{ page_obj.previous_page_number }}&{{ request.GET.urlencode }}">&lsaquo; Anterior</a>
        {% endif %}

        <span class="current">
            Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
        </span>

        {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}&{{ request.GET.urlencode }}">Próxima &rsaquo;</a>
        <a href="?page={{ page_obj.paginator.num_pages }}&{{ request.GET.urlencode }}">Última &raquo;</a>
        {% endif %}
    </div>

</div>
{% else %}
{% if page_obj %}
<div class="pagination">
    <div class="pagination-controls"></div>
</div>
{% endif %}
{% endif %}

<!-- Total de registros -->
{% if page_obj %}
<div class="text-center mt-3">
    <i class="fas fa-check-circle me-1 text-success"></i>
    <strong>Total de registros: {{ page_obj.paginator.count }}</strong>
</div>
{% endif %}

<!-- Modal Processar Lançamento -->
<div class="modal fade" id="modalProcessar" tabindex="-1" aria-labelledby="modalProcessarLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalProcessarLabel">
                    <i class="fas fa-check-circle text-success me-2"></i>
                    Processar Lançamento
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja processar este lançamento manual?</p>
                <p class="text-muted">Esta ação não pode ser desfeita.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="btnConfirmarProcessar">
                    <i class="fas fa-check me-1"></i> Processar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Cancelar Lançamento -->
<div class="modal fade" id="modalCancelar" tabindex="-1" aria-labelledby="modalCancelarLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalCancelarLabel">
                    <i class="fas fa-times-circle text-danger me-2"></i>
                    Cancelar Lançamento
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja cancelar este lançamento manual?</p>
                <div class="mb-3">
                    <label for="motivoCancelamento" class="form-label">Motivo do cancelamento:</label>
                    <textarea class="form-control" id="motivoCancelamento" rows="3"
                        placeholder="Informe o motivo do cancelamento..." required></textarea>
                </div>
                <p class="text-muted">Esta ação não pode ser desfeita.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Voltar</button>
                <button type="button" class="btn btn-danger" id="btnConfirmarCancelar">
                    <i class="fas fa-times me-1"></i> Cancelar Lançamento
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/lancamentos_manuais_list.js' %}"></script>
<script>
    // Salvar status automaticamente quando alterado
    document.querySelectorAll('.status-select').forEach(select => {
        select.addEventListener('change', function () {
            const lancamentoId = this.dataset.lancamentoId;
            const novoStatus = this.value;
            const statusOriginal = this.dataset.statusOriginal;
            const selectElement = this;

            // Desabilitar select durante salvamento
            selectElement.disabled = true;

            // Fazer requisição AJAX para atualizar
            fetch(`{% url 'portais_admin:lancamentos_manuais_list' %}`.replace('lancamentos_manuais/', `lancamentos_manuais/${lancamentoId}/atualizar/`), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    status: novoStatus
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Atualizar status original
                        selectElement.dataset.statusOriginal = novoStatus;

                        // Feedback visual
                        selectElement.style.backgroundColor = '#d4edda';
                        setTimeout(() => {
                            selectElement.style.backgroundColor = '';
                        }, 1000);

                        // Toast de sucesso
                        showToast('Status atualizado com sucesso!', 'success');
                    } else {
                        // Reverter para status original
                        selectElement.value = statusOriginal;
                        showToast('Erro ao atualizar status: ' + data.message, 'error');
                    }
                })
                .catch(error => {
                    // Reverter para status original
                    selectElement.value = statusOriginal;
                    showToast('Erro ao atualizar status', 'error');
                    console.error('Erro:', error);
                })
                .finally(() => {
                    selectElement.disabled = false;
                });
        });
    });

    // Função para mostrar toast
    function showToast(message, type) {
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed top-0 end-0 m-3`;
        toast.style.zIndex = '9999';
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.remove();
        }, 3000);
    }
</script>
{% endblock %}
