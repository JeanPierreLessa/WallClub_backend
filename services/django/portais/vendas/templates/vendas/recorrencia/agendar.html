{% extends 'vendas/base.html' %}

{% block title %}Agendar Recorr√™ncia - Portal de Vendas{% endblock %}

{% block content %}
<div class="page-header">
    <h2><i class="fas fa-calendar-plus me-2"></i>{{ titulo }}</h2>
    <p class="text-muted mb-0">Configure uma cobran√ßa recorrente autom√°tica</p>
</div>

<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Dados da Recorr√™ncia</h5>
            </div>
            <div class="card-body">
                <form method="POST" id="formRecorrencia">
                    {% csrf_token %}
                    
                    <!-- Buscar Cliente -->
                    <div class="mb-3">
                        <label for="documento" class="form-label">CPF/CNPJ do Cliente *</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="documento" placeholder="Digite CPF ou CNPJ">
                            <button class="btn btn-outline-secondary" type="button" id="btnBuscarCliente">
                                <i class="fas fa-search"></i> Buscar
                            </button>
                        </div>
                        <small class="text-muted">Cliente deve estar cadastrado e possuir cart√µes tokenizados</small>
                    </div>
                    
                    <!-- Dados do Cliente (preenchidos ap√≥s busca) -->
                    <input type="hidden" id="cliente_id" name="cliente_id">
                    <input type="hidden" id="cartao_tokenizado_id" name="cartao_tokenizado_id">
                    
                    <div class="alert alert-success" id="dadosCliente" style="display: none;">
                        <strong><i class="fas fa-user me-2"></i><span id="clienteNome"></span></strong><br>
                        <small><span id="clienteEmail"></span></small>
                    </div>
                    
                    <!-- Cart√µes Tokenizados -->
                    <div class="mb-3">
                        <label for="cartao_selecionado" class="form-label">Cart√£o para Cobran√ßa Recorrente *</label>
                        <select class="form-select" id="cartao_selecionado" name="cartao_selecionado">
                            <option value="">Busque o cliente primeiro para ver os cart√µes</option>
                        </select>
                        <small class="text-muted">Escolha um cart√£o cadastrado ou envie link para o cliente cadastrar um novo</small>
                    </div>
                    
                    <!-- Alerta se cliente n√£o tem cart√µes -->
                    <div class="alert alert-info" id="divSemCartoes" style="display: none;">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Cliente sem cart√µes salvos.</strong> Ser√° enviado um link de pagamento para o cliente cadastrar o cart√£o com seguran√ßa.
                    </div>
                    
                    <hr>
                    
                    <!-- Descri√ß√£o da Recorr√™ncia -->
                    <div class="mb-3">
                        <label for="descricao" class="form-label">Descri√ß√£o da Cobran√ßa *</label>
                        <input type="text" class="form-control" id="descricao" name="descricao" 
                               placeholder="Ex: Mensalidade Academia, Assinatura Premium, etc."
                               maxlength="255">
                        <small class="text-muted">Esta descri√ß√£o ser√° enviada ao cliente nas notifica√ß√µes de cobran√ßa</small>
                    </div>

                    <div class="mb-3">
                        <label for="valor" class="form-label">Valor da Recorr√™ncia *</label>
                        <div class="input-group">
                            <span class="input-group-text">R$</span>
                            <input type="text" class="form-control" id="valor" name="valor" 
                                   placeholder="0,00">
                        </div>
                    </div>

                    <!-- Tipo de Periodicidade -->
                    <div class="mb-3">
                        <label for="tipo_periodicidade" class="form-label">Tipo de Periodicidade *</label>
                        <select class="form-select" id="tipo_periodicidade" name="tipo_periodicidade">
                            <option value="">Selecione...</option>
                            {% for value, label in tipos_periodicidade %}
                                <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Campos para Mensal Dia Fixo -->
                    <div id="campos_mensal" style="display: none;">
                        <div class="mb-3">
                            <label for="dia_cobranca" class="form-label">Dia do M√™s para Cobran√ßa *</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-calendar-day"></i></span>
                                <input type="number" class="form-control" id="dia_cobranca" name="dia_cobranca" 
                                       min="1" max="31" placeholder="Ex: 15">
                            </div>
                            <small class="text-muted">Dia do m√™s (1-31). Se n√£o existir no m√™s, ajusta para pr√≥ximo dia √∫til.</small>
                        </div>
                    </div>

                    <!-- Campos para Anual Data Fixa -->
                    <div id="campos_anual" style="display: none;">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="mes_cobranca_anual" class="form-label">M√™s *</label>
                                <select class="form-select" id="mes_cobranca_anual" name="mes_cobranca_anual">
                                    <option value="">Selecione...</option>
                                    <option value="1">Janeiro</option>
                                    <option value="2">Fevereiro</option>
                                    <option value="3">Mar√ßo</option>
                                    <option value="4">Abril</option>
                                    <option value="5">Maio</option>
                                    <option value="6">Junho</option>
                                    <option value="7">Julho</option>
                                    <option value="8">Agosto</option>
                                    <option value="9">Setembro</option>
                                    <option value="10">Outubro</option>
                                    <option value="11">Novembro</option>
                                    <option value="12">Dezembro</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="dia_cobranca_anual" class="form-label">Dia *</label>
                                <input type="number" class="form-control" id="dia_cobranca_anual" name="dia_cobranca_anual" 
                                       min="1" max="31" placeholder="Ex: 25">
                            </div>
                        </div>
                        <small class="text-muted">Data espec√≠fica do ano (ex: 25/12 para Natal)</small>
                    </div>
                    
                    <!-- Bot√µes -->
                    <div class="d-flex gap-2 mt-4">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-check me-2"></i>Agendar Recorr√™ncia
                        </button>
                        <a href="{% url 'vendas:recorrencia_listar' %}" class="btn btn-secondary">
                            <i class="fas fa-times me-2"></i>Cancelar
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Card de Informa√ß√µes -->
        <div class="card mt-3">
            <div class="card-body">
                <h6 class="text-primary"><i class="fas fa-info-circle me-2"></i>Como funciona?</h6>
                <ul class="mb-0">
                    <li><strong>Mensal Dia Fixo:</strong> Cobran√ßa todo m√™s no dia escolhido (ex: todo dia 15)</li>
                    <li><strong>Anual Data Fixa:</strong> Cobran√ßa 1x por ano na data espec√≠fica (ex: 25/12)</li>
                    <li>Se a data cair em fim de semana, a cobran√ßa ser√° ajustada para o pr√≥ximo dia √∫til</li>
                    <li>M√°ximo de 3 tentativas autom√°ticas em caso de falha (D+1, D+3, D+7)</li>
                    <li>Ap√≥s 3 falhas, a recorr√™ncia entra em HOLD e requer a√ß√£o manual</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Buscar cliente via AJAX
    document.getElementById('btnBuscarCliente').addEventListener('click', function() {
        const documento = document.getElementById('documento').value.replace(/\D/g, '');
        
        if (!documento) {
            alert('Digite o CPF ou CNPJ');
            return;
        }
        
        const btn = this;
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Buscando...';
        
        // Buscar via AJAX
        const lojaId = {{ loja_id }};
        
        fetch(`{% url 'vendas:ajax_buscar_cliente' %}?loja_id=${lojaId}&documento=${documento}`)
            .then(response => response.json())
            .then(data => {
                if (data.sucesso) {
                    // Preencher dados do cliente
                    document.getElementById('cliente_id').value = data.cliente.id;
                    document.getElementById('clienteNome').textContent = data.cliente.nome;
                    document.getElementById('clienteEmail').textContent = data.cliente.email;
                    
                    const temCartoes = data.cartoes && data.cartoes.length > 0;
                    const selectCartao = document.getElementById('cartao_selecionado');
                    
                    // SEMPRE permitir op√ß√£o de enviar link, mesmo com cart√µes cadastrados
                    selectCartao.innerHTML = '<option value="">Selecione uma op√ß√£o</option>';
                    
                    if (temCartoes) {
                        // Adicionar cart√µes existentes
                        data.cartoes.forEach(cartao => {
                            const option = document.createElement('option');
                            option.value = cartao.id;
                            option.textContent = `${cartao.bandeira} - ${cartao.mascarado} - Vencimento: ${cartao.validade}`;
                            selectCartao.appendChild(option);
                        });
                        
                        // Adicionar op√ß√£o de enviar link (mesmo com cart√µes)
                        const optionNovoCartao = document.createElement('option');
                        optionNovoCartao.value = 'novo_cartao';
                        optionNovoCartao.textContent = 'üìß Enviar link de pagamento para cadastrar novo cart√£o';
                        selectCartao.appendChild(optionNovoCartao);
                        
                        document.getElementById('divSemCartoes').style.display = 'none';
                    } else {
                        // Cliente SEM cart√µes - apenas op√ß√£o de link
                        const optionNovoCartao = document.createElement('option');
                        optionNovoCartao.value = 'novo_cartao';
                        optionNovoCartao.textContent = 'Enviar link de pagamento para cadastrar cart√£o';
                        selectCartao.appendChild(optionNovoCartao);
                        selectCartao.value = 'novo_cartao';
                        document.getElementById('cartao_tokenizado_id').value = 'novo_cartao';
                        document.getElementById('divSemCartoes').style.display = 'block';
                    }
                    
                    document.getElementById('dadosCliente').style.display = 'block';
                } else {
                    alert(data.mensagem || 'Cliente n√£o encontrado');
                }
            })
            .catch(error => {
                console.error('Erro ao buscar cliente:', error);
                alert('Erro ao buscar cliente. Tente novamente.');
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = originalText;
            });
    });
    
    // Atualizar campo hidden quando selecionar cart√£o
    document.getElementById('cartao_selecionado').addEventListener('change', function() {
        document.getElementById('cartao_tokenizado_id').value = this.value;
    });
    
    const tipoPeriodicidade = document.getElementById('tipo_periodicidade');
    const camposMensal = document.getElementById('campos_mensal');
    const camposAnual = document.getElementById('campos_anual');
    const diaCobranca = document.getElementById('dia_cobranca');
    const mesCobrancaAnual = document.getElementById('mes_cobranca_anual');
    const diaCobrancaAnual = document.getElementById('dia_cobranca_anual');
    
    // Mostrar/ocultar campos conforme tipo
    tipoPeriodicidade.addEventListener('change', function() {
        if (this.value === 'mensal_dia_fixo') {
            camposMensal.style.display = 'block';
            camposAnual.style.display = 'none';
            diaCobranca.required = true;
            mesCobrancaAnual.required = false;
            diaCobrancaAnual.required = false;
        } else if (this.value === 'anual_data_fixa') {
            camposMensal.style.display = 'none';
            camposAnual.style.display = 'block';
            diaCobranca.required = false;
            mesCobrancaAnual.required = true;
            diaCobrancaAnual.required = true;
        } else {
            camposMensal.style.display = 'none';
            camposAnual.style.display = 'none';
            diaCobranca.required = false;
            mesCobrancaAnual.required = false;
            diaCobrancaAnual.required = false;
        }
    });
    
    // M√°scara de moeda
    const valorInput = document.getElementById('valor');
    valorInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        value = (value / 100).toFixed(2).replace('.', ',');
        e.target.value = value;
    });
    
    // Validar formul√°rio antes de submeter
    document.getElementById('formRecorrencia').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validar campos obrigat√≥rios
        const clienteId = document.getElementById('cliente_id').value;
        const cartaoId = document.getElementById('cartao_tokenizado_id').value;
        const descricao = document.getElementById('descricao').value;
        const valor = document.getElementById('valor').value;
        const tipoPeriodicidade = document.getElementById('tipo_periodicidade').value;
        
        if (!clienteId) {
            alert('Busque e selecione um cliente primeiro');
            return false;
        }
        
        if (!cartaoId) {
            alert('Selecione um cart√£o para cobran√ßa');
            return false;
        }
        
        if (!descricao || descricao.trim() === '') {
            alert('Informe a descri√ß√£o da cobran√ßa');
            return false;
        }
        
        if (!valor || parseFloat(valor.replace(',', '.')) <= 0) {
            alert('Informe um valor v√°lido');
            return false;
        }
        
        if (!tipoPeriodicidade) {
            alert('Selecione o tipo de periodicidade');
            return false;
        }
        
        // Validar campos espec√≠ficos de periodicidade
        if (tipoPeriodicidade === 'mensal_dia_fixo') {
            const dia = document.getElementById('dia_cobranca').value;
            if (!dia || dia < 1 || dia > 31) {
                alert('Informe o dia da cobran√ßa mensal (1-31)');
                return false;
            }
        } else if (tipoPeriodicidade === 'anual_data_fixa') {
            const mes = document.getElementById('mes_cobranca_anual').value;
            const dia = document.getElementById('dia_cobranca_anual').value;
            if (!mes || !dia) {
                alert('Informe o m√™s e dia da cobran√ßa anual');
                return false;
            }
        }
        
        // Se passou todas valida√ß√µes, submeter
        this.submit();
    });
});
</script>
{% endblock %}
