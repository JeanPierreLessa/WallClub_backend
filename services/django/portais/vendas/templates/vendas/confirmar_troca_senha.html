{% extends 'vendas/base.html' %}
{% load static %}

{% block title %}Confirmar Troca de Senha - Portal Vendas{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-shield-alt me-2"></i>
                        Confirmar Troca de Senha
                    </h4>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Token enviado por email!</strong><br>
                        Verifique sua caixa de entrada e digite o token de confirmação abaixo.
                        <br><small class="text-muted">O token é válido por 30 minutos.</small>
                    </div>
                    
                    <form method="post" id="otpForm">
                        {% csrf_token %}
                        
                        <div class="mb-4">
                            <label class="form-label text-center d-block">
                                <i class="fas fa-key me-1"></i>Token de Confirmação
                            </label>
                            
                            <div class="otp-container d-flex justify-content-center gap-2 mb-3">
                                <input type="text" class="otp-input form-control text-center" maxlength="1" data-index="0" autocomplete="off">
                                <input type="text" class="otp-input form-control text-center" maxlength="1" data-index="1" autocomplete="off">
                                <input type="text" class="otp-input form-control text-center" maxlength="1" data-index="2" autocomplete="off">
                                <input type="text" class="otp-input form-control text-center" maxlength="1" data-index="3" autocomplete="off">
                                <input type="text" class="otp-input form-control text-center" maxlength="1" data-index="4" autocomplete="off">
                                <input type="text" class="otp-input form-control text-center" maxlength="1" data-index="5" autocomplete="off">
                            </div>
                            
                            <input type="hidden" id="token" name="token" required>
                            
                            <small class="text-muted d-block text-center">
                                Digite o código de 6 dígitos recebido por email
                            </small>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-check me-2"></i>
                                Confirmar Alteração
                            </button>
                            
                            <a href="{% url 'vendas:trocar_senha' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>
                                Voltar para Trocar Senha
                            </a>
                        </div>
                    </form>
                    
                    <hr class="my-4">
                    
                    <div class="text-center">
                        <small class="text-muted">
                            <i class="fas fa-question-circle me-1"></i>
                            Não recebeu o email? Verifique sua pasta de spam ou 
                            <a href="{% url 'vendas:trocar_senha' %}" class="text-decoration-none">
                                solicite um novo token
                            </a>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.otp-container {
    max-width: 400px;
    margin: 0 auto;
}

.otp-input {
    width: 55px;
    height: 60px;
    font-size: 24px;
    font-weight: bold;
    font-family: monospace;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    transition: all 0.3s;
}

.otp-input:focus {
    border-color: #2563eb;
    box-shadow: 0 0 0 0.2rem rgba(37, 99, 235, 0.25);
    outline: none;
}

.otp-input.filled {
    background-color: #eff6ff;
    border-color: #2563eb;
}

.btn-lg {
    padding: 0.75rem 1.5rem;
    font-size: 1.1rem;
}

.alert-info {
    border-left: 4px solid #0dcaf0;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const inputs = document.querySelectorAll('.otp-input');
    const tokenInput = document.getElementById('token');
    const form = document.getElementById('otpForm');
    
    inputs[0].focus();
    
    inputs.forEach((input, index) => {
        input.addEventListener('input', function(e) {
            const value = e.target.value;
            
            if (!/^[A-Za-z0-9]$/.test(value)) {
                e.target.value = '';
                return;
            }
            
            e.target.value = value.toUpperCase();
            e.target.classList.add('filled');
            updateToken();
            
            if (index < inputs.length - 1) {
                inputs[index + 1].focus();
            } else if (isComplete()) {
                form.submit();
            }
        });
        
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Backspace') {
                if (e.target.value === '' && index > 0) {
                    inputs[index - 1].focus();
                    inputs[index - 1].value = '';
                    inputs[index - 1].classList.remove('filled');
                } else {
                    e.target.value = '';
                    e.target.classList.remove('filled');
                }
                updateToken();
            }
            
            if (e.key === 'ArrowLeft' && index > 0) {
                e.preventDefault();
                inputs[index - 1].focus();
            }
            
            if (e.key === 'ArrowRight' && index < inputs.length - 1) {
                e.preventDefault();
                inputs[index + 1].focus();
            }
        });
        
        input.addEventListener('paste', function(e) {
            e.preventDefault();
            const pastedData = e.clipboardData.getData('text').toUpperCase().replace(/[^A-Z0-9]/g, '');
            
            if (pastedData.length === 6) {
                inputs.forEach((inp, idx) => {
                    inp.value = pastedData[idx] || '';
                    if (inp.value) inp.classList.add('filled');
                });
                updateToken();
                inputs[5].focus();
                
                if (isComplete()) {
                    setTimeout(() => form.submit(), 300);
                }
            }
        });
        
        input.addEventListener('focus', function(e) {
            e.target.select();
        });
    });
    
    function updateToken() {
        tokenInput.value = Array.from(inputs).map(inp => inp.value).join('');
    }
    
    function isComplete() {
        return Array.from(inputs).every(inp => inp.value !== '');
    }
});
</script>
{% endblock %}
