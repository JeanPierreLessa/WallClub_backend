# Deploy Simplificado - WallClub Backend v2.0

## SSH - Acesso ao Servidor

```bash
# Servidor de produção (atual)
ssh -i /Users/jeanlessa/wall_projects/aws/webserver-dev.pem ubuntu@10.0.1.124
cd /var/www/WallClub_backend
```

---

## Deploy Completo (Primeira Vez ou Mudanças Estruturais)

```bash
# Pull do código
git pull origin v2.0.0

# Subir todos os containers
docker-compose down
docker-compose up -d --build

# Verificar status
docker ps
```

---

## Deploy de Rotina (Atualizar Código)

### Opção 1: Deploy Completo (Recomendado)
```bash
# Pull do código
git pull origin v2.0.0

# Rebuild e restart tudo
docker-compose down
docker-compose up -d --build

# Verificar
docker ps
docker logs wallclub-portais --tail 30
```

### Opção 2: Deploy Seletivo (Apenas containers específicos)
```bash
# Pull do código
git pull origin v2.0.0

# Rebuild containers específicos
docker-compose build --no-cache wallclub-portais wallclub-apis wallclub-pos

# Remover e recriar
docker rm -f wallclub-portais wallclub-apis wallclub-pos
docker-compose up -d wallclub-portais wallclub-apis wallclub-pos

# Verificar
docker ps
docker logs wallclub-apis --tail 30
```

---

## Deploy Rápido (Apenas Restart - Sem Mudanças de Código)

```bash
docker-compose restart wallclub-portais wallclub-apis wallclub-pos wallclub-riskengine
```

---

## Containers Ativos

- **nginx** - Gateway (porta 8005 externa)
- **wallclub-portais** - Admin + Lojista + Vendas + Corporativo
- **wallclub-apis** - APIs Mobile + Checkout
- **wallclub-pos** - Terminal POS
- **wallclub-riskengine** - Antifraude
- **wallclub-redis** - Cache + Broker Celery
- **wallclub-celery-worker-portais** - Worker Celery Portais
- **wallclub-celery-worker-apis** - Worker Celery APIs
- **wallclub-celery-beat** - Scheduler Celery

---

## Logs e Monitoramento

```bash
# Status de todos os containers
docker ps

# Logs individuais
docker logs wallclub-portais --tail 100 -f
docker logs wallclub-apis --tail 100 -f
docker logs wallclub-pos --tail 100 -f
docker logs wallclub-riskengine --tail 100 -f
docker logs wallclub-celery-worker-portais --tail 100 -f
docker logs wallclub-celery-worker-apis --tail 100 -f
docker logs wallclub-celery-beat --tail 100 -f
docker logs nginx --tail 100 -f
```

---

## Testes de Endpoints OAuth

```bash
# Testar API Mobile (wallclub-apis)
curl -H "Host: wcapi.wallclub.com.br" http://localhost:8005/api/oauth/token/ \
  -X POST \
  -H "Content-Type: application/json" \
  -d '{
    "client_id": "wallclub_mobile_rls_310",
    "client_secret": "wallclub_mobile_XXXGYsz7CThOUgPXWhsgNsC9mnkXNJz_ncH1nwmSerChQLY1uC0DX1ewDsJ8Dr3wMyJ",
    "grant_type": "client_credentials"
  }'

# Testar POS (wallclub-pos)
curl -H "Host: apipos.wallclub.com.br" http://localhost:8005/api/oauth/token/ \
  -X POST \
  -H "Content-Type: application/json" \
  -d '{
    "client_id": "posp2",
    "client_secret": "posp2_N93cAK62qbBq332ElQ4ZZjn26dNhF13Dmn_Lb2ATSftbYFH9bAhsqwPj4gWBw06o",
    "grant_type": "client_credentials"
  }'
```

---

## Troubleshooting

### Erro: ContainerConfig
```bash
# Remover container órfão
docker rm -f <container_id>

# Limpar containers parados
docker container prune -f

# Subir novamente
docker-compose up -d
```

### Erro: MySQL Connection Refused
- Verificar se `ENVIRONMENT=production` no `.env`
- Verificar se AWS Secrets Manager está acessível
- Verificar logs: `docker logs wallclub-apis --tail 100`

### Erro: Invalid HTTP_HOST header
- Verificar se `ALLOWED_HOSTS` está no `.env`
- Verificar se domínio está configurado no nginx

---

## Limpeza e Manutenção

```bash
# Parar todos os containers
docker-compose down

# Remover containers parados
docker container prune -f

# Remover imagens não utilizadas
docker image prune -a -f

# Limpeza completa (CUIDADO!)
docker system prune -a -f

# Verificar espaço
docker system df
```


