# DIRETRIZES UNIFICADAS - WALLCLUB ECOSYSTEM

**Vers√£o:** 4.0  
**Data:** 05/11/2025  
**Fontes:** Fases 1-6 completas + Django DIRETRIZES.md + Risk Engine DIRETRIZES.md  
**Mudan√ßas:** 4 containers independentes, 9 regras antifraude, Sistema Multi-Portal, 26 APIs internas

---

## üìã √çNDICE

1. [Regras Fundamentais](#regras-fundamentais)
2. [Containers Desacoplados](#containers-desacoplados) ‚≠ê NOVO
3. [Banco de Dados](#banco-de-dados)
4. [Timezone e Datas](#timezone-e-datas)
5. [Valores Monet√°rios](#valores-monet√°rios)
6. [APIs REST](#apis-rest)
7. [Autentica√ß√£o e Seguran√ßa](#autentica√ß√£o-e-seguran√ßa)
8. [Sistema Antifraude](#sistema-antifraude)
9. [Notifica√ß√µes](#notifica√ß√µes)
10. [Arquitetura Docker](#arquitetura-docker)
11. [Boas Pr√°ticas de C√≥digo](#boas-pr√°ticas-de-c√≥digo)

**Documentos Completos:**
- [Django DIRETRIZES (3428 linhas)](../1.%20DIRETRIZES.md)
- [Risk Engine DIRETRIZES (875 linhas)](../../wallclub-riskengine/docs/DIRETRIZES.md)

---

## üî¥ REGRAS FUNDAMENTAIS

### Comunica√ß√£o e Valida√ß√£o

**SEMPRE:**
- ‚úÖ Falar em portugu√™s
- ‚úÖ Ser t√©cnico e direto (sem floreios)
- ‚úÖ Responder SOMENTE com base no c√≥digo vis√≠vel
- ‚úÖ Fazer perguntas breves para esclarecer
- ‚úÖ Listar op√ß√µes com pr√≥s/contras
- ‚úÖ Respeitar formato solicitado (JSON, markdown, etc)

**NUNCA:**
- ‚ùå Inventar c√≥digos, vari√°veis, m√©todos ou APIs
- ‚ùå Criar c√≥digo n√£o solicitado explicitamente
- ‚ùå Completar fun√ß√µes sem pedido direto
- ‚ùå Usar dados hardcoded (s√≥ quando expl√≠cito)
- ‚ùå Assumir o que o usu√°rio quer

### Controle de Escopo Absoluto

**Antes de responder:**
> "Essa resposta foi solicitada exatamente?"

**Sempre perguntar antes de:**
- Propor solu√ß√µes que exijam a√ß√µes do usu√°rio
- Mudar abordagem quando algo falhar
- Implementar requisitos n√£o validados

---

## üê≥ CONTAINERS DESACOPLADOS

**Status:** Fase 6 completa (6A+6B+6C+6D) - 4 containers em produ√ß√£o (05/11/2025)

### Regra de Ouro: Zero Imports Diretos

**PROIBIDO:**
```python
# ‚ùå ERRADO - Import direto entre containers
from posp2.models import Terminal
from checkout.models import CheckoutCliente
from apps.ofertas.services import OfertaService
```

**OBRIGAT√ìRIO:**
```python
# ‚úÖ CORRETO - Lazy import
from django.apps import apps

def minha_funcao():
    Terminal = apps.get_model('posp2', 'Terminal')
    terminal = Terminal.objects.get(id=1)
```

### 3 Estrat√©gias de Comunica√ß√£o (Fase 6B)

**1. APIs REST Internas (70% dos casos) - 26 endpoints**

```python
# Exemplo: Consultar saldo
import requests

response = requests.post(
    'http://localhost:8000/api/internal/conta-digital/consultar-saldo/',
    json={'cpf': '12345678900', 'canal_id': 1},
    timeout=5
)

if response.status_code == 200:
    data = response.json()
    saldo = data['saldo_disponivel']
```

**26 Endpoints Dispon√≠veis:**
- Conta Digital: 5 endpoints (consultar-saldo, autorizar-uso, debitar-saldo, estornar-saldo, calcular-maximo)
- Checkout Recorr√™ncias: 8 endpoints (listar, criar, obter, pausar, reativar, cobrar, atualizar, deletar)
- Ofertas: 6 endpoints (listar, criar, obter, atualizar, grupos/listar, grupos/criar)
- Par√¢metros: 7 endpoints (configuracoes/loja, configuracoes/contar, configuracoes/ultima, loja/modalidades, planos, importacoes, importacoes/{id})

**Caracter√≠sticas:**
- OAuth 2.0 (scope `internal`)
- Sem rate limiting
- Timeout: 5s consulta, 10s escrita
- Retry autom√°tico em falhas

**2. SQL Direto (25% - read-only)**

```python
# Exemplo: Buscar transa√ß√µes
from comum.database.queries import TransacoesQueries

transacoes = TransacoesQueries.listar_transacoes_periodo(
    loja_id=1,
    data_inicio='2025-11-01',
    data_fim='2025-11-30'
)
```

**Classes Dispon√≠veis:**
- `TransacoesQueries` - 7 m√©todos
- `TerminaisQueries` - 2 m√©todos

**Regras:**
- ‚úÖ Apenas leitura (SELECT)
- ‚úÖ Queries complexas com performance cr√≠tica
- ‚ùå Nunca INSERT/UPDATE/DELETE
- ‚ùå Nunca acessar models Django de outro container

**3. Lazy Imports (5% - entidades compartilhadas)**

```python
# Usar apenas quando ABSOLUTAMENTE necess√°rio
from django.apps import apps

def processar_cliente(cliente_id):
    Cliente = apps.get_model('cliente', 'Cliente')
    cliente = Cliente.objects.get(id=cliente_id)
    # ...
```

**Labels Corretos:**
- ‚úÖ `'cliente'` (N√ÉO 'apps.cliente')
- ‚úÖ `'ofertas'` (N√ÉO 'apps.ofertas')
- ‚úÖ `'checkout'`
- ‚úÖ `'pinbank'`
- ‚úÖ `'posp2'`
- ‚úÖ `'link_pagamento_web'` (N√ÉO 'checkout.link_pagamento_web')

### Valida√ß√£o Autom√°tica

```bash
# Rodar antes de commit
bash scripts/validar_dependencias.sh

# Esperado:
# ‚úì SUCESSO: Containers desacoplados!
# Pr√≥ximo: Fase 6C - Extrair CORE
```

### Type Hints com Lazy Imports

```python
from typing import Any  # N√£o usar tipo espec√≠fico

def processar(terminal: Any) -> dict:  # ‚úÖ CORRETO
    Terminal = apps.get_model('posp2', 'Terminal')
    # ...

# ‚ùå ERRADO - import direto para type hint
from posp2.models import Terminal
def processar(terminal: Terminal) -> dict:
    pass
```

### CORE Limpo

**Regra:** `comum/*` NUNCA importa de `apps/*`, `posp2/*`, `checkout/*`, `portais/*`

```python
# comum/services/exemplo.py

# ‚ùå ERRADO
from apps.cliente.models import Cliente

# ‚úÖ CORRETO - CORE n√£o conhece apps
# Caller deve passar dados necess√°rios
def enviar_notificacao(cliente_id: int, celular: str, nome: str):
    # CORE s√≥ envia, n√£o busca Cliente
    pass
```

**Valida√ß√£o CORE:**
```bash
bash scripts/validar_core_limpo.sh
# Esperado: CORE limpo, 0 imports diretos
```

---

## üíæ BANCO DE DADOS

### Collation Obrigat√≥ria (MySQL)

**Padr√£o:** `utf8mb4_unicode_ci` (compat√≠vel MySQL 5.7 e 8.0)

**Template CREATE TABLE:**
```sql
CREATE TABLE nome_tabela (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    campo_texto VARCHAR(255) COLLATE utf8mb4_unicode_ci,
    campo_numero DECIMAL(10,2),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

**Converter Existente:**
```sql
-- Altera TUDO: estrutura + dados + colunas
ALTER TABLE nome_tabela 
  CONVERT TO CHARACTER SET utf8mb4 
  COLLATE utf8mb4_unicode_ci;
```

**Verificar Inconsist√™ncias:**
```sql
-- Tabelas com collation diferente
SELECT TABLE_NAME, TABLE_COLLATION 
FROM information_schema.TABLES 
WHERE TABLE_SCHEMA = 'wallclub' 
  AND TABLE_COLLATION != 'utf8mb4_unicode_ci';

-- Colunas com collation diferente
SELECT TABLE_NAME, COLUMN_NAME, COLLATION_NAME 
FROM information_schema.COLUMNS 
WHERE TABLE_SCHEMA = 'wallclub' 
  AND COLLATION_NAME IS NOT NULL
  AND COLLATION_NAME != 'utf8mb4_unicode_ci';
```

**Regra de Ouro:**
- ‚ùå NUNCA usar `COLLATE` em queries SQL
- ‚úÖ Padronizar collation no schema
- Se precisar COLLATE na query = schema est√° errado

### Configura√ß√µes Django

**OBRIGAT√ìRIO:**
- ‚ùå N√ÉO usar migrations Django
- ‚úÖ SEMPRE criar tabelas via SQL direto
- ‚úÖ Credenciais sempre via AWS Secrets Manager (sem fallback)

---

## üìÖ TIMEZONE E DATAS

### Configura√ß√£o Obrigat√≥ria

**Django settings:**
```python
USE_TZ = False
TIME_ZONE = 'America/Sao_Paulo'
```

**Container Docker:**
```dockerfile
ENV TZ=America/Sao_Paulo
```

### Uso Correto

**SEMPRE usar:**
```python
from datetime import datetime

# ‚úÖ CORRETO
agora = datetime.now()
data_futura = datetime.now() + timedelta(days=30)
```

**NUNCA usar:**
```python
from django.utils import timezone

# ‚ùå ERRADO - Gera timezone-aware
agora = timezone.now()
data_aware = timezone.make_aware(datetime.now())
```

**Motivo:** MySQL backend do Django n√£o suporta timezone-aware datetimes quando USE_TZ=False

**Arquivos Corrigidos (26/10/2025):**
- posp2/models.py
- parametros_wallclub/models.py
- apps/cliente/models.py
- apps/conta_digital/models.py
- checkout/link_pagamento_web/models.py

---

## üí∞ VALORES MONET√ÅRIOS

### Formata√ß√£o e Armazenamento

**Frontend:**
- Aceitar entrada brasileira: `2.030,22` (v√≠rgula decimal)
- Converter v√≠rgula‚Üíponto antes de enviar backend

**Backend:**
```python
# ‚úÖ SEMPRE usar Decimal
from decimal import Decimal

valor = Decimal('110.50')  # Ponto decimal
percentual = Decimal('0.02')  # 2%

# ‚ùå NUNCA usar float
valor = 110.50  # Imprecis√£o
```

**Banco de Dados:**
```sql
valor_transacao DECIMAL(10,2)  -- SEMPRE com ponto
percentual_desconto DECIMAL(5,4)  -- Ex: 0.0199 = 1.99%
```

**Exibi√ß√£o:**
- Monet√°rio: `R$ 2.030,22` (ponto=milhares, v√≠rgula=decimal)
- Percentual: `0,2 ‚Üí 20,00%` (multiplicar por 100)

**Campos HTML:**
```html
<!-- ‚úÖ CORRETO: Evita flechinhas -->
<input type="text" name="valor" placeholder="110,50">

<!-- ‚ùå ERRADO: Flechinhas confundem usu√°rio -->
<input type="number" name="valor">
```

### Valida√ß√£o

```python
def validar_valor_monetario(valor_str):
    """Aceita v√≠rgula e ponto no input"""
    valor_str = valor_str.replace('.', '').replace(',', '.')
    return Decimal(valor_str)
```

---

## üåê APIS REST

### M√©todo HTTP Obrigat√≥rio

**SEMPRE usar POST:**
```python
# ‚úÖ CORRETO
@api_view(['POST'])
def minha_api(request):
    dados = request.data  # Body JSON
    cpf = dados.get('cpf')
```

**NUNCA usar GET/PUT/DELETE:**
- ‚ùå GET: exp√µe dados sens√≠veis na URL
- ‚ùå PUT/DELETE: complexidade desnecess√°ria
- ‚úÖ POST: par√¢metros no body, simplifica POS/apps

**Motivos:**
- Simplifica integra√ß√£o terminais POS
- Evita problemas cache/logs de URL
- Dados sens√≠veis nunca expostos

### Formato de Resposta Padr√£o

**SEMPRE usar:**
```json
{
  "sucesso": true,
  "mensagem": "Opera√ß√£o realizada com sucesso",
  "dados": {...}
}
```

**NUNCA usar:**
```json
{
  "success": true,  // ‚ùå Ingl√™s
  "error": "...",   // ‚ùå Ingl√™s
  "data": {...}     // ‚ùå Ingl√™s
}
```

### URLs de Arquivos

**SEMPRE salvar URLs completas:**
```python
# ‚úÖ CORRETO
url_completa = f"https://apidj.wallclub.com.br/media/ofertas/{filename}"
oferta.imagem_url = url_completa

# ‚ùå ERRADO - Apps m√≥veis precisam de URL absoluta
oferta.imagem_url = f"/media/ofertas/{filename}"
```

---

## üîê AUTENTICA√á√ÉO E SEGURAN√áA

### Sistema JWT Customizado ‚≠ê (Fase 1 + 4)

**Status:** 18 cen√°rios testados (28/10/2025)  
**Corre√ß√£o Cr√≠tica:** 26/10/2025 - Valida√ß√£o obrigat√≥ria contra tabela em produ√ß√£o**

**Tokens:**
- Access: 30 dias (JWT customizado)
- Refresh: 60 dias (reutiliz√°vel)

{{ ... }}
**Tabelas:**
- `cliente_jwt_tokens` - Auditoria completa
- `otp_autenticacao` - C√≥digos OTP (5min)
- `otp_dispositivo_confiavel` - Devices (30 dias)
- `cliente_autenticacao` - Tentativas login
- `cliente_bloqueios` - Hist√≥rico bloqueios
- `cliente_senhas_historico` - Hist√≥rico senhas

### Valida√ß√£o Obrigat√≥ria Tokens (26/10/2025)

**CR√çTICO - Falha de Seguran√ßa Corrigida:**

‚ùå **ERRADO:** Apenas decodificar JWT
```python
payload = jwt.decode(token, SECRET_KEY, algorithms=['HS256'])
return (ClienteUser(payload), token)
```

‚úÖ **CORRETO:** Validar contra tabela
```python
payload = jwt.decode(token, SECRET_KEY, algorithms=['HS256'])

# CR√çTICO: Validar contra tabela de auditoria
jti = payload.get('jti')
if jti:
    jwt_record = ClienteJWTToken.validate_token(token, jti)
    if not jwt_record:
        raise AuthenticationFailed('Token inv√°lido ou revogado')
    jwt_record.record_usage()  # Registrar uso
else:
    raise AuthenticationFailed('Token inv√°lido')

return (ClienteUser(payload), token)
```

### 5 Regras de Ouro - Tokens JWT

1. ‚úÖ **SEMPRE validar JWT contra tabela** - nunca confiar apenas na decodifica√ß√£o
2. ‚úÖ **SEMPRE revogar tokens anteriores** ao gerar novo
3. ‚úÖ **SEMPRE incluir JTI** no payload (rejeitar sem JTI)
4. ‚úÖ **SEMPRE registrar uso** (last_used, ip_address)
5. ‚úÖ **NUNCA permitir m√∫ltiplos tokens ativos** para mesmo cliente

### Rate Limiting

**Progressivo:**
- 1¬™ tentativa: sem bloqueio
- 5 falhas/15min: bloqueio 1h
- 10 falhas/1h: bloqueio 24h
- 20 falhas/24h: bloqueio permanente (manual)

**Redis:**
```python
# Chaves
f"login_attempts:{cpf}:15min"
f"login_attempts:{cpf}:1h"
f"login_attempts:{cpf}:24h"

# TTLs
900s, 3600s, 86400s
```

### Login Simplificado Fintech (Fase 4 - 25/10/2025)

**Filosofia:** Senha sempre via SMS, revalida√ß√£o recorrente (modelo Nubank/PicPay)

**Fluxo:**
```
Cadastro ‚Üí Senha SMS (4 d√≠gitos) ‚Üí JWT 30 dias ‚Üí Biometria
                                          ‚Üì
                                   (Ap√≥s 30 dias)
                                          ‚Üì
                                   2FA ‚Üí Novo JWT 30 dias
```

**Princ√≠pios:**
- ‚úÖ N√ÉO existe "senha definitiva"
- ‚úÖ JWT v√°lido 30 dias (era 1 dia)
- ‚úÖ Celular revalidado 30 dias (era 90)
- ‚úÖ Biometria desde dia 1
- ‚úÖ 2FA apenas quando necess√°rio

**Inspira√ß√£o:** Nubank, PicPay, Inter, C6 Bank

### OAuth 2.0

**Grant Type:** `client_credentials`  
**Expiration:** 3600s (1h)  
**Header:** `Authorization: Bearer <token>`

**Contextos Separados:**
- Admin: `RISK_ENGINE_ADMIN_CLIENT_ID/SECRET`
- POS: `RISK_ENGINE_POS_CLIENT_ID/SECRET`
- Internal: `RISK_ENGINE_INTERNAL_CLIENT_ID/SECRET`

---

## üõ°Ô∏è SISTEMA ANTIFRAUDE (Fase 2)

**Status:** Operacional desde 16/10/2025  
**Integra√ß√µes:** POSP2 + Checkout Web + Portal Admin

### Arquitetura Risk Engine

**Container:** wallclub-riskengine:8004  
**Lat√™ncia:** <200ms m√©dia  
**Fail-open:** Erro n√£o bloqueia transa√ß√µes

**Score de Risco:**
```
MaxMind (0-100) + Regras (+pontos) = Score Final

Decis√£o:
0-59: APROVADO ‚úÖ
60-79: REVISAR ‚ö†Ô∏è
80-100: REPROVADO üö´
```

### 9 Regras Antifraude (5 b√°sicas + 4 autentica√ß√£o)

**Regras B√°sicas:**
| # | Nome | Pontos | L√≥gica |
|---|------|--------|--------|
| 1 | Velocidade Alta | +80 | >3 tx em 10min |
| 2 | Valor Suspeito | +70 | >m√©dia √ó 3 |
| 3 | Dispositivo Novo | +50 | Fingerprint novo |
| 4 | Hor√°rio Incomum | +40 | 00h-05h |
| 5 | IP Suspeito | +90 | >5 CPFs no IP/24h |

**Regras Autentica√ß√£o (Fase 2 - 30/10/2025):**
| # | Nome | Pontos | L√≥gica |
|---|------|--------|--------|
| 6 | Dispositivo Novo - Alto Valor | +70 | Device <7 dias + valor >R$500 |
| 7 | IP Novo + Hist√≥rico Bloqueios | +80 | IP <3 dias + 2+ bloqueios/30d |
| 8 | M√∫ltiplas Tentativas Falhas | +60 | 5+ falhas/24h + taxa ‚â•30% |
| 9 | Cliente com Bloqueio Recente | +90 | Bloqueio <7 dias |

**C√°lculo:** `score += peso √ó 10`

**Exce√ß√£o:** Regra com `acao=REPROVAR` ‚Üí REPROVADO (ignora score)

### Integra√ß√µes

**POSP2:**
- Arquivo: `posp2/services_antifraude.py` (374 linhas)
- Intercepta linha ~333 (antes Pinbank)

**Checkout Web:**
- Arquivo: `checkout/services_antifraude.py` (268 linhas)
- Intercepta linhas 117-183 (antes Pinbank)
- 7 campos novos: score_risco, decisao_antifraude, motivo_bloqueio, etc
- 2 status novos: BLOQUEADA_ANTIFRAUDE, PENDENTE_REVISAO

**Decis√µes:**
- APROVADO: processa normalmente
- REPROVADO: bloqueia (n√£o processa Pinbank)
- REVISAR: processa + marca para an√°lise manual

### MaxMind minFraud

**Cache:** Redis 1h  
**Fallback:** Score neutro 50  
**Timeout:** 3s  
**Custo:** R$ 50-75/m√™s

**Chave Redis:** `maxmind:{cpf}:{valor}:{ip}`

**Princ√≠pio:** Sistema NUNCA bloqueia por falha t√©cnica

### Sistema Seguran√ßa Multi-Portal (Fase 2 - 23/10/2025)

**6 Detectores Autom√°ticos (Celery 5min):**
1. Login M√∫ltiplo (Sev 4) - 3+ IPs/10min
2. Tentativas Falhas (Sev 5) - 5+ reprova√ß√µes/5min
3. IP Novo (Sev 3) - IP nunca visto
4. Hor√°rio Suspeito (Sev 2) - 02:00-05:00
5. Velocidade (Sev 4) - 10+ tx/5min
6. Localiza√ß√£o An√¥mala - MaxMind GeoIP

**Middleware:**
- Valida IP/CPF antes login
- Fail-open (erro n√£o bloqueia)
- Arquivo: `comum/middleware/security_validation.py`

**Bloqueio Autom√°tico:**
- Severidade 5 ‚Üí bloqueio imediato
- Task: `bloquear_automatico_critico()` (10min)

---

## üì¨ NOTIFICA√á√ïES

### WhatsApp Business (29/10/2025)

**Templates Din√¢micos:**
- `2fa_login_app` (AUTHENTICATION)
- `senha_acesso` (AUTHENTICATION)
- `baixar_app` (UTILITY)

**Categorias:**
- AUTHENTICATION: sempre entrega
- UTILITY: funcional
- MARKETING: requer opt-in

**Ordem Par√¢metros SMS:**
```
/TELEFONE/MENSAGEM/SHORTCODE/ASSUNTO
```

**URL Encoding:**
```python
# ‚úÖ CORRETO: Preserva URLs
mensagem_encoded = quote(mensagem, safe=':/')
# Resultado: https://tinyurl.com/abc

# ‚ùå ERRADO: Codifica tudo
mensagem_encoded = quote(mensagem, safe='')
# Resultado: https:%2F%2Ftinyurl.com%2Fabc
```

### Push Notifications

**NUNCA hardcodar:**
```python
# ‚ùå ERRADO
payload["aps"]["category"] = "AUTORIZACAO_SALDO"

# ‚úÖ CORRETO: Din√¢mico do template
payload["aps"]["category"] = tipo_push  # Do banco
```

**Firebase (Android):**
```json
{
  "notification": {...},
  "data": {
    "tipo": "oferta",
    "oferta_id": "123"
  }
}
```

**APN (iOS):**
- Bundle ID: din√¢mico da tabela canal
- Fallback: produ√ß√£o ‚Üí sandbox autom√°tico
- Token: UUID completo (n√£o truncar)

---

## üê≥ ARQUITETURA DOCKER

### 9 Containers Orquestrados (Fase 6D - 05/11/2025)

| Container | CPU | RAM | Porta | Workers | M√≥dulos |
|-----------|-----|-----|-------|---------|---------|
| Django | 1.5 | 2GB | 8003 | 3 |
| Risk Engine | 0.5 | 512MB | 8004 | 3 |
| Redis | 0.25 | 256MB | 6379 | - |
| Celery Worker | 0.5 | 256MB | - | 4 |
| Celery Beat | 0.25 | 128MB | - | - |

### Deploy

**Completo:**
```bash
cd /var/www/wallclub_django
docker-compose down
docker-compose up -d --build
```

**Seletivo (mant√©m Redis):**
```bash
docker-compose up -d --build --no-deps web riskengine celery-worker celery-beat
```

**Logs:**
```bash
docker-compose logs -f web
docker-compose logs -f riskengine
docker-compose logs -f celery-worker
```

### Benef√≠cios

- ‚úÖ Isolamento responsabilidades
- ‚úÖ Escalabilidade independente
- ‚úÖ Resili√™ncia (falha isolada)
- ‚úÖ Deploy at√¥mico ou seletivo
- ‚úÖ Zero downtime cache

---

## üíª BOAS PR√ÅTICAS DE C√ìDIGO

### Gest√£o de Vari√°veis (24/10/2025)

**Regra de Ouro:** Resolver vari√°veis UMA √öNICA VEZ

‚ùå **ERRADO:** Buscar m√∫ltiplas vezes
```python
id_loja = cursor.fetchone()[0]
# ... c√≥digo ...
id_loja = cursor.fetchone()[0]  # SOBRESCREVE!
```

‚úÖ **CORRETO:** Resolver no in√≠cio
```python
id_loja = dados_terminal['loja_id']  # Linha 145

# Usar em todos c√°lculos
valor = calculadora.calcular(
    id_loja=id_loja  # Vari√°vel j√° resolvida
)
```

### Cargas Pinbank (25/10/2025)

**Li√ß√µes Aprendidas:**

1. **Processar lote residual:**
```python
# Sempre ap√≥s loop principal
if lote_atual:
    with transaction.atomic():
        processar_lote(lote_atual)
```

2. **Evitar queries em loops:**
```python
# ‚úÖ Montar info_loja localmente
linha['info_loja'] = {
    'id': linha.get('clienteId'),
    'loja': linha.get('razao_social')
}
```

3. **N√£o sobrescrever vari√°veis:**
```python
# valores[45] j√° foi calculado acima
# N√ÉO sobrescrever
```

4. **Preservar dados hist√≥ricos:**
```python
# Data de pagamento √© imut√°vel
registro_existente = Model.objects.filter(nsu=nsu).first()
if registro_existente and registro_existente.data_pagamento:
    valores[45] = registro_existente.data_pagamento
```

### Sistema de Logs (28/10/2025)

**N√≠veis:**
- DEBUG: valida√ß√µes OK, fluxo normal
- INFO: opera√ß√µes conclu√≠das
- WARNING: valida√ß√µes negadas, anomalias
- ERROR: exce√ß√µes cr√≠ticas

**Categoria:**
```python
import logging
logger = logging.getLogger('comum.modulo')
logger = logging.getLogger('apps.modulo')
```

**Boas Pr√°ticas:**
```python
# ‚úÖ Sempre especificar n√≠vel
logger.debug(f"Token validado: {jti[:8]}...")
logger.info(f"Cliente {cliente_id} autenticado")
logger.warning(f"Rate limit: {cpf}")
logger.error(f"Erro cr√≠tico: {str(e)}")

# ‚úÖ Mensagens descritivas
logger.info("‚úÖ Senha trocada com sucesso")
logger.warning("‚ö†Ô∏è Dispositivo n√£o confi√°vel")
logger.error("‚ùå Falha ao processar pagamento")
```

### Nomenclatura

**Python:**
- Vari√°veis/fun√ß√µes: `snake_case`
- Classes: `PascalCase`
- Constantes: `UPPER_SNAKE_CASE`

**Arquivos:**
- Python: `snake_case.py`
- Templates: `snake_case.html`
- SQL: `snake_case.sql`

**Banco:**
- Tabelas: `snake_case` ou legado
- Colunas: `snake_case` ou camelCase (legado)

---

## üìö REFER√äNCIAS R√ÅPIDAS

### Comandos Docker

```bash
# Status containers
docker-compose ps

# Logs tempo real
docker-compose logs -f web

# Restart container
docker-compose restart web

# Entrar no container
docker exec -it wallclub-prod-release300 bash

# Redis CLI
docker exec -it wallclub-redis redis-cli
```

### Queries √öteis

```sql
-- Verificar collation
SELECT TABLE_NAME, TABLE_COLLATION 
FROM information_schema.TABLES 
WHERE TABLE_SCHEMA = 'wallclub';

-- Tokens ativos
SELECT COUNT(*) FROM cliente_jwt_tokens 
WHERE is_active = TRUE;

-- Bloqueios ativos
SELECT COUNT(*) FROM bloqueios_seguranca 
WHERE ativo = TRUE;

-- Transa√ß√µes √∫ltimas 24h
SELECT COUNT(*) FROM baseTransacoesGestao 
WHERE created_at >= NOW() - INTERVAL 24 HOUR;
```

### Health Checks

```bash
# Django
curl http://localhost:8003/api/v1/health/

# Risk Engine
curl http://localhost:8004/api/antifraude/health/

# Redis
docker exec wallclub-redis redis-cli ping
```

---

## ‚ö†Ô∏è ATEN√á√ïES CR√çTICAS

### Seguran√ßa

1. ‚úÖ Tokens JWT validados contra BD (26/10)
2. ‚úÖ Rate limiting progressivo ativo
3. ‚úÖ Fail-open em sistemas externos
4. ‚úÖ Logs sem dados sens√≠veis completos
5. ‚úÖ Credenciais via AWS Secrets

### Performance

1. ‚úÖ Cache Redis (1h MaxMind)
2. ‚úÖ Streaming cargas (100 registros/lote)
3. ‚úÖ Queries otimizadas (sem N+1)
4. ‚úÖ Decimal para monet√°rios (n√£o float)
5. ‚úÖ Collation padronizada (sem convers√µes)

### Operacional

1. ‚úÖ Deploy seletivo (mant√©m Redis)
2. ‚úÖ Logs separados por container
3. ‚úÖ Celery tasks monitoradas
4. ‚úÖ Antifraude com lat√™ncia <200ms
5. ‚úÖ Backup volumes persistentes

---

**√öltima atualiza√ß√£o:** 02/11/2025  
**Pr√≥xima revis√£o:** Fase 6D (Separa√ß√£o f√≠sica containers)  
**Manuten√ß√£o:** Jean Lessa + Claude AI
