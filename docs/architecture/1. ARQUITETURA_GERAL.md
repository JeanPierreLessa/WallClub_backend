# ARQUITETURA GERAL - WALLCLUB ECOSYSTEM

**VersÃ£o:** 4.0  
**Data:** 05/11/2025  
**Fontes:** Fases 1-6 completas (ROTEIRO_CONCLUIDO + FASE_6_COMPLETA + FASE_6D_CONCLUIDA)  
**MudanÃ§as:** 4 containers independentes em produÃ§Ã£o, 9 containers totais, nginx gateway, Fases 1-6 concluÃ­das

---

## ğŸ“‹ NAVEGAÃ‡ÃƒO RÃPIDA

1. [Sobre o Projeto](#sobre-o-projeto)
2. [Arquitetura de Containers](#arquitetura-de-containers)
3. [Status da MigraÃ§Ã£o](#status-da-migraÃ§Ã£o)
4. [Funcionalidades Principais](#funcionalidades-principais)
5. [Risk Engine](#risk-engine)
6. [Estrutura de DiretÃ³rios](#estrutura-de-diretÃ³rios)
7. [Deploy](#deploy)

**Documentos Detalhados:**
- [Django README completo (1117 linhas)](../2.%20README.md)
- [Risk Engine README completo (839 linhas)](../../wallclub-riskengine/docs/README.md)
- [Diretrizes tÃ©cnicas](../1.%20DIRETRIZES.md)

---

## ğŸ“‹ SOBRE O PROJETO

### WallClub Django (Projeto Principal)

**Sistema fintech** migrado PHPâ†’Django, operacional desde 16/10/2025.

**Responsabilidades:**
- APIs REST mÃ³veis (JWT customizado - 18 cenÃ¡rios testados)
- Terminais POS (OAuth 2.0)
- Checkout Web (links + recorrÃªncias)
- 4 Portais (Admin, Lojista, Vendas, Corporativo)
- Cargas Pinbank (TEF, Credenciadora, Checkout)
- ParÃ¢metros financeiros (3.840 configuraÃ§Ãµes - 100% validado vs PHP)
- Conta digital (saldo, cashback, autorizaÃ§Ãµes)

**Stack:**
- Django 4.2.23 + DRF 3.16.1
- MySQL 8.0 (wallclub + wclub legado)
- Redis 7 (cache + OAuth)
- Gunicorn 21.2.0 (3 workers)
- AWS Secrets Manager

### WallClub Risk Engine (Container Isolado)

**Sistema antifraude** em tempo real desde 16/10/2025.

**Responsabilidades:**
- AnÃ¡lise risco (score 0-100)
- 5 regras antifraude configurÃ¡veis
- MaxMind minFraud integration
- 3D Secure 2.0 support
- Portal revisÃ£o manual
- 6 detectores automÃ¡ticos (Celery)

**Stack:**
- Django 4.2.11 (isolado)
- Redis DB 1 (cache separado)
- Celery (worker + beat)
- OAuth 2.0 inter-containers

**IntegraÃ§Ãµes:**
- âœ… POSP2 (Terminal POS)
- âœ… Checkout Web (22/10/2025)
- âœ… Portal Admin
- âœ… Sistema SeguranÃ§a Multi-Portal (23/10/2025)

---

## ğŸ³ ARQUITETURA DE CONTAINERS

### Status Atual: 4 Containers Independentes em ProduÃ§Ã£o âœ…

**Fases 1-6 ConcluÃ­das (05/11/2025):**
- âœ… **Fase 1:** SeguranÃ§a BÃ¡sica (Rate limiting, OAuth, Auditoria, CPF)
- âœ… **Fase 2:** Antifraude (MaxMind, 5 regras, Dashboard, POSP2/Checkout integrados)
- âœ… **Fase 3:** Services (22 services criados, 25 queries eliminadas)
- âœ… **Fase 4:** 2FA + Device Management (Checkout 2FA, Login Simplificado, Bypass Apple/Google)
- âœ… **Fase 5:** UnificaÃ§Ã£o Portais (Sistema Multi-Portal, RecorrÃªncias, RPR)
- âœ… **Fase 6A:** CORE Limpo (0 imports de apps)
- âœ… **Fase 6B:** DependÃªncias Resolvidas (26 APIs REST + 17 lazy imports)
- âœ… **Fase 6C:** Monorepo + wallclub_core (113 arquivos migrados)
- âœ… **Fase 6D:** 4 Containers Independentes (9 containers totais com Celery)

### 9 Containers em ProduÃ§Ã£o

```
Internet (80/443)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  NGINX Gateway (porta 8005)                    â”‚
â”‚  â”œâ”€ admin.wallclub.com.br    â†’ portais:8005   â”‚
â”‚  â”œâ”€ vendas.wallclub.com.br   â†’ portais:8005   â”‚
â”‚  â”œâ”€ lojista.wallclub.com.br  â†’ portais:8005   â”‚
â”‚  â”œâ”€ api.wallclub.com.br      â†’ apis:8007      â”‚
â”‚  â”œâ”€ apipos.wallclub.com.br   â†’ pos:8006       â”‚
â”‚  â””â”€ checkout.wallclub.com.br â†’ apis:8007      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚         â”‚         â”‚         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚         â”‚         â”‚         â”‚         â”‚
â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”â”Œâ”€â”€â”´â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”â”Œâ”€â”€â”´â”€â”€â”€â”€â”
â”‚Portais â”‚â”‚ POS   â”‚â”‚ APIs   â”‚â”‚ Risk   â”‚â”‚ Redis â”‚
â”‚:8005   â”‚â”‚ :8006 â”‚â”‚ :8007  â”‚â”‚ :8008  â”‚â”‚ :6379 â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜â””â”€â”€â”€â”¬â”€â”€â”€â”˜â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚         â”‚        â”‚         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                â”‚
â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
â”‚Celery      â”‚  â”‚Celery      â”‚
â”‚Worker      â”‚  â”‚Beat        â”‚
â”‚(Portais+   â”‚  â”‚(Scheduler) â”‚
â”‚ APIs)      â”‚  â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Container 1: Portais (wallclub-portais)

**Porta:** 8005 (interna)  
**Recursos:** 3 workers, 1GB RAM, 1.0 CPU

**MÃ³dulos:**
- `portais/admin/` - Portal administrativo
- `portais/lojista/` - Portal lojista  
- `portais/vendas/` - Portal vendas/checkout interno
- `portais/controle_acesso/` - Sistema Multi-Portal
- `sistema_bancario/` - GestÃ£o bancÃ¡ria

**Settings:** `wallclub.settings.portais`  
**URLs:** `wallclub.urls_portais`  
**Deploy:** Frequente (features admin/lojista)

### Container 2: POS (wallclub-pos)

**Porta:** 8006 (interna)  
**Recursos:** 2 workers, 512MB RAM, 0.5 CPU

**Funcionalidades:**
- `posp2/` - Terminal POS (OAuth 2.0)
- `pinbank/` - IntegraÃ§Ã£o Pinbank + Cargas
- `parametros_wallclub/` - ParÃ¢metros financeiros (3.840 configs)

**Settings:** `wallclub.settings.pos`  
**URLs:** `wallclub.urls_pos`  
**Deploy:** Raro (sistema crÃ­tico)

### Container 3: APIs Mobile (wallclub-apis)

**Porta:** 8007 (interna)  
**Recursos:** 4 workers, 1GB RAM, 1.0 CPU

**MÃ³dulos:**
- `apps/cliente/` - JWT Customizado (18 cenÃ¡rios testados)
- `apps/conta_digital/` - Saldo, Cashback, AutorizaÃ§Ãµes
- `apps/ofertas/` - Sistema de Ofertas Push
- `apps/transacoes/` - TransaÃ§Ãµes mobile
- `checkout/` - Checkout Web + 2FA WhatsApp

**Settings:** `wallclub.settings.apis`  
**URLs:** `wallclub.urls_apis`  
**Deploy:** MÃ©dio (features app mobile)

### Container 2: Redis (wallclub-redis)

**Porta:** 6379

**Databases:**
- DB 0: Django (tokens OAuth, sessÃµes, rate limiting)
- DB 1: Risk Engine (MaxMind scores, regras)

**TTLs:**
- OAuth: 1h
- MaxMind: 1h
- Rate limit: 15min/1h/24h
- OTP: 5min

### Container 4: Risk Engine (wallclub-riskengine)

**Porta:** 8008 (interna)  
**Acesso:** Interno (chamado por outros containers), 512MB RAM, 0.5 CPU

**Funcionalidades:**
- AnÃ¡lise risco <200ms
- 9 regras antifraude (5 bÃ¡sicas + 4 autenticaÃ§Ã£o)
- MaxMind minFraud (score 0-100, cache 1h)
- Sistema SeguranÃ§a Multi-Portal (6 detectores)
- Portal revisÃ£o manual
- Blacklist/Whitelist automÃ¡tica

**Thresholds:**
- 0-59: APROVADO âœ…
- 60-79: REVISAR âš ï¸
- 80-100: REPROVADO ğŸš«

**IntegraÃ§Ãµes:**
- âœ… POSP2 (intercepta antes Pinbank)
- âœ… Checkout Web (7 campos antifraude)
- âœ… Portal Admin (dashboard + revisÃ£o)
- âœ… Sistema SeguranÃ§a (validate-login, bloqueios)

### Container 4: Celery Worker

**Recursos:** 4 workers, 256MB RAM

**Tasks:**
- detectar_atividades_suspeitas (5min)
- bloquear_automatico_critico (10min)
- ExportaÃ§Ãµes grandes
- NotificaÃ§Ãµes massa

### Container 5: Celery Beat

**Recursos:** 128MB RAM

**Schedule:**
- 5min: detectar_atividades_suspeitas
- 10min: bloquear_automatico_critico

### Deploy Unificado

```bash
cd /var/www/wallclub_django

# Todos containers
docker-compose up -d --build

# Seletivo (mantÃ©m Redis)
docker-compose up -d --build --no-deps web riskengine

# Status
docker-compose ps

# Logs
docker-compose logs -f web
docker-compose logs -f riskengine
```

**RepositÃ³rio:**
- Monorepo: `/var/www/wallclub`
  - Django: `services/django/`
  - Risk Engine: `services/riskengine/`
  - Core: `services/core/` (package compartilhado)

---

### Arquitetura Futura: 5 Containers Independentes (Fase 6D)

**Status:** CÃ³digo pronto, aguardando extraÃ§Ã£o do CORE

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  NGINX Gateway (80/443)        â”‚
â”‚  Roteamento por path           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚       â”‚        â”‚        â”‚        â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â” â”Œâ”€â–¼â”€â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”
â”‚APP1  â”‚ â”‚APP2 â”‚ â”‚APP3 â”‚ â”‚APP4  â”‚ â”‚Redisâ”‚
â”‚8001  â”‚ â”‚8002 â”‚ â”‚8003 â”‚ â”‚8004  â”‚ â”‚6379 â”‚
â”‚Portalâ”‚ â”‚POS  â”‚ â”‚APIs â”‚ â”‚Risk  â”‚ â”‚     â”‚
â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜
   â”‚        â”‚       â”‚        â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
    â”‚               â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
â”‚wallclub  â”‚ â”‚  MySQL   â”‚
â”‚  -core   â”‚ â”‚ (shared) â”‚
â”‚ (package)â”‚ â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**APP1 - wallclub-portais (8001):**
- Portais: admin, lojista, vendas, corporativo
- Controle de acesso
- Sistema bancÃ¡rio
- **Deploy:** Frequente
- **Auth:** SessÃ£o Django

**APP2 - wallclub-pos (8002):**
- POSP2 (terminais)
- Pinbank (cargas)
- ParÃ¢metros financeiros
- **Deploy:** Raro (crÃ­tico)
- **Auth:** OAuth 2.0

**APP3 - wallclub-apis (8003):**
- APIs Mobile (JWT)
- Checkout Web
- Cliente/Conta Digital
- Ofertas
- **Deploy:** MÃ©dio
- **Auth:** JWT customizado

**APP4 - wallclub-riskengine (8004):** âœ… JÃ¡ existe
- Antifraude
- MaxMind
- Portal revisÃ£o

**CORE - wallclub-core (package):**
- comum/* (49 arquivos)
- Compartilhado entre todos
- Instalado via pip

**ComunicaÃ§Ã£o Inter-Containers:**
- 26 APIs REST internas (OAuth 2.0)
- SQL direto (read-only queries)
- Lazy imports (apps.get_model)

---

## âœ… STATUS DA MIGRAÃ‡ÃƒO

### Marcos HistÃ³ricos

**Fase 0: PreparaÃ§Ã£o (Ago-Set/2025)**
- âœ… 3.840 parÃ¢metros migrados
- âœ… 100% validaÃ§Ã£o Django vs PHP (168/168)
- âœ… Calculadoras com fidelidade total

**Fase 1: APIs (Set/2025)**
- âœ… APIs Mobile + JWT
- âœ… OAuth 2.0 completo
- âœ… Deploy AWS (16/10)

**Fase 2: Antifraude (Out/2025)**
- âœ… Risk Engine (16/10)
- âœ… POSP2 integrado
- âœ… Checkout integrado (22/10)
- âœ… MaxMind + fallback

**Fase 3: RefatoraÃ§Ã£o (Out/2025)**
- âœ… 22 services criados
- âœ… 25 queries eliminadas
- âœ… Sistema bancÃ¡rio refatorado

**Fase 4: AutenticaÃ§Ã£o Enterprise (Out/2025)**
- âœ… JWT Customizado (28/10) - 18 cenÃ¡rios
- âœ… 2FA Checkout (18/10)
- âœ… Device Management (18/10)
- âœ… SeguranÃ§a Multi-Portal (23/10)
- âœ… Login Simplificado Fintech (25/10)
- âœ… **CorreÃ§Ã£o crÃ­tica tokens revogados (26/10)**

**Fase 5: Portal Vendas (Out/2025)**
- âœ… UnificaÃ§Ã£o portais (24/10)
- âœ… Checkout + recorrÃªncias
- â³ Celery Beat (tasks prontas)

**Fase 6: SeparaÃ§Ã£o em MÃºltiplos Containers (Out-Nov/2025)**
- âœ… **6A - CORE Limpo (30/10):** 0 imports de apps, pronto para extraÃ§Ã£o
- âœ… **6B - DependÃªncias Cruzadas (01/11):** 103 imports resolvidos
  - 26 APIs REST internas (OAuth 2.0)
  - 17 arquivos com lazy imports
  - 2 classes SQL direto (9 mÃ©todos)
  - Fix crÃ­tico RPR (dict vs getattr)
- âœ… **6C - Monorepo Unificado (02/11):** wallclub_core extraÃ­do + monorepo criado
  - Package wallclub_core (52 arquivos)
  - 113 arquivos migrados (108 Django + 5 Risk Engine)
  - Estrutura: wallclub/services/{django,riskengine,core}
  - DiretÃ³rio comum/ removido
- â³ **6D - SeparaÃ§Ã£o FÃ­sica:** 5 containers independentes

### Taxa de Sucesso

- CÃ¡lculos Financeiros: **100%** (168/168)
- APIs Mobile: **100%** funcional
- Antifraude: **<200ms** latÃªncia
- Deploy: **Zero downtime**

**Detalhes completos:** Ver [Django README linhas 403-444](../2.%20README.md#status-da-migraÃ§Ã£o)

---

## ğŸ¯ FUNCIONALIDADES PRINCIPAIS

### 1. Sistema JWT Customizado â­

**Status:** 18 cenÃ¡rios testados (28/10/2025)

**Endpoints:**
- Cadastro: iniciar, validar_otp, finalizar
- Login: rate limiting 5/15min, 10/1h, 20/24h
- Reset senha: solicitar, validar, trocar
- 2FA: verificar, solicitar, validar
- Dispositivos: listar, revogar
- Refresh: renovar access_token

**Tabelas:**
- cliente_jwt_tokens (auditoria completa)
- otp_autenticacao (cÃ³digos 5min)
- otp_dispositivo_confiavel (30 dias)
- cliente_autenticacao (tentativas)
- cliente_bloqueios (histÃ³rico)
- cliente_senhas_historico

**CorreÃ§Ã£o CrÃ­tica 26/10:**
- Tokens revogados continuavam funcionando
- Agora: validaÃ§Ã£o obrigatÃ³ria is_active + revoked_at
- Novo login revoga tokens anteriores

**Arquivos:** `apps/cliente/jwt_cliente.py`, `views_2fa_login.py`, `services_2fa_login.py`

**DocumentaÃ§Ã£o:** [TESTE_CURL_USUARIO.md](../TESTE_CURL_USUARIO.md)

### 2. Sistema de Ofertas Push

**SegmentaÃ§Ã£o:**
- todos_canal (todos ativos)
- grupo_customizado (VIP, Novos, etc)

**Push:**
- Firebase: `{"tipo": "oferta", "oferta_id": "X"}`
- APN: fallback produÃ§Ã£oâ†’sandbox
- Templates dinÃ¢micos (BD)

**APIs:**
- `/ofertas/lista_ofertas/` - Com segmentaÃ§Ã£o
- `/ofertas/detalhes_oferta/` - Valida acesso

**Portais:**
- Admin: CRUD + grupos + disparo
- Lojista: CRUD filtrado por canal

### 3. AutorizaÃ§Ã£o Uso Saldo (Wall Cashback)

**Fluxo:**
1. POS consulta saldo (CPF + senha) â†’ auth_token 15min
2. POS solicita autorizaÃ§Ã£o â†’ push app cliente
3. Cliente aprova/nega no app (180s)
4. POS verifica status (polling)
5. DÃ©bito automÃ¡tico apÃ³s INSERT transactiondata

**MovimentaÃ§Ãµes:**
- CRÃ‰DITO Cashback: cashback_bloqueado (30 dias)
- DÃ‰BITO Uso Saldo: cashback_disponivel (lock pessimista)

**Formato:** `{"sucesso": bool, "mensagem": str}`

**Arquivos:** `posp2/services_conta_digital.py`, `apps/cliente/views_saldo.py`

### 4. Cargas Pinbank

**Extrato POS:**
- Periodicidades: 30min, 72h, 60d, ano
- Command: `carga_extrato_pos`
- Lock: execuÃ§Ã£o Ãºnica

**Base GestÃ£o:**
- 130+ variÃ¡veis (var0-var130)
- Streaming: 100 registros/lote
- Command: `carga_base_gestao`
- Service: CalculadoraBaseGestao (1178 linhas)

**Ajustes Manuais:**
- InserÃ§Ãµes faltantes: transactiondata
- RemoÃ§Ãµes duplicatas: baseTransacoesGestao
- SQL direto com auditoria

### 5. Sistema Checkout

**Web (Link Pagamento):**
- Token Ãºnico 30min
- Antifraude integrado
- 2FA WhatsApp (OTP 6 dÃ­gitos)
- Limite progressivo R$100â†’200â†’500

**Portal Vendas:**
- CRUD clientes
- TokenizaÃ§Ã£o cartÃµes
- 3 formas pagamento
- Pulldown unificado

**RecorrÃªncias:**
- Models: RecorrenciaAgendada
- Link tokenizaÃ§Ã£o separado
- Celery tasks prontas
- â³ AtivaÃ§Ã£o Celery Beat

**Antifraude (7 campos novos):**
- score_risco (0-100)
- decisao_antifraude
- motivo_bloqueio
- antifraude_response
- revisado_por/em
- observacao_revisao

**Status novos:**
- BLOQUEADA_ANTIFRAUDE
- PENDENTE_REVISAO

### 6. ParÃ¢metros Financeiros

**Estrutura:**
- 3.840 configuraÃ§Ãµes ativas
- 133 planos (PIX, DÃ‰BITO, CRÃ‰DITO, PARCELADO)
- Granularidade: (loja, plano, vigÃªncia)

**CalculadoraDesconto:**
- 100% validado (168/168 vs PHP)
- Formas: PIX, DÃ‰BITO, Ã€ VISTA, PARCELADO 2-12x
- IntegraÃ§Ã£o: ParametrosService

**Mapeamento:**
- 1-30: parametro_loja_X
- 31-36: parametro_uptal_X
- 37-40: parametro_wall_X

---

## ğŸ›¡ï¸ RISK ENGINE

### VisÃ£o Geral

**Container:** wallclub-riskengine:8004  
**LatÃªncia:** <200ms mÃ©dia

**Score:**
```
MaxMind (0-100) + Regras (+pontos) = Score Final
0-59: APROVADO âœ…
60-79: REVISAR âš ï¸
80-100: REPROVADO ğŸš«
```

### 5 Regras Antifraude

| Nome | Pontos | LÃ³gica |
|------|--------|--------|
| Velocidade | +80 | >3 tx em 10min |
| Valor | +70 | >mÃ©dia Ã— 3 |
| Device | +50 | Fingerprint novo |
| HorÃ¡rio | +40 | 00h-05h |
| IP | +90 | >5 CPFs no IP/24h |

### IntegraÃ§Ãµes

**POSP2:**
- Arquivo: `posp2/services_antifraude.py` (374 linhas)
- Intercepta antes do Pinbank (linha ~333)
- Dados: CPF, valor, modalidade, BIN, terminal

**Checkout Web:**
- Arquivo: `checkout/services_antifraude.py` (268 linhas)
- Intercepta linhas 117-183
- Dados: CPF, valor, cartÃ£o, IP, device_fingerprint
- DecisÃµes: APROVADO/REPROVADO/REVISAR

**Portal Admin:**
- Dashboard: `/admin/antifraude/`
- Pendentes: `/admin/antifraude/pendentes/`
- HistÃ³rico: `/admin/antifraude/historico/`

### SeguranÃ§a Multi-Portal (23/10)

**Middleware:**
- Valida IP/CPF antes login
- Fail-open (erro nÃ£o bloqueia)
- Arquivo: `comum/middleware/security_validation.py`

**6 Detectores (Celery 5min):**
1. Login MÃºltiplo (3+ IPs)
2. Tentativas Falhas (5+ em 5min)
3. IP Novo
4. HorÃ¡rio Suspeito (02:00-05:00)
5. Velocidade TransaÃ§Ã£o (10+ em 5min)
6. LocalizaÃ§Ã£o AnÃ´mala (MaxMind)

**Telas:**
- Atividades Suspeitas: `/admin/seguranca/atividades/`
- Bloqueios: `/admin/seguranca/bloqueios/`

### APIs REST

**OAuth 2.0:**
```bash
curl -X POST http://localhost:8004/oauth/token/ \
  -d "grant_type=client_credentials" \
  -d "client_id=wallclub_django_internal" \
  -d "client_secret=..."
```

**Endpoints:**
- `POST /api/antifraude/analyze/` - AnÃ¡lise completa
- `GET /api/antifraude/decision/<id>/` - Consulta decisÃ£o
- `POST /api/antifraude/validate-3ds/` - Valida 3DS
- `GET /api/antifraude/health/` - Health check
- `POST /api/antifraude/validate-login/` - Valida IP/CPF
- `GET /api/antifraude/suspicious/` - Atividades suspeitas
- `POST /api/antifraude/block/` - Cria bloqueio
- `GET /api/antifraude/blocks/` - Lista bloqueios

**Detalhes completos:** [Risk Engine README](../../wallclub-riskengine/docs/README.md)

---

## ğŸ“ ESTRUTURA DE DIRETÃ“RIOS

### Django Principal

```
wallclub_django/
â”œâ”€â”€ apps/                       # APIs Mobile
â”‚   â”œâ”€â”€ cliente/               # JWT Customizado (18 cenÃ¡rios)
â”‚   â”‚   â”œâ”€â”€ jwt_cliente.py
â”‚   â”‚   â”œâ”€â”€ views_2fa_login.py
â”‚   â”‚   â”œâ”€â”€ views_dispositivos.py
â”‚   â”‚   â””â”€â”€ views_senha.py
â”‚   â”œâ”€â”€ conta_digital/         # Conta digital + cashback
â”‚   â””â”€â”€ ofertas/               # Sistema ofertas push
â”œâ”€â”€ parametros_wallclub/        # Sistema parÃ¢metros (3.840)
â”‚   â”œâ”€â”€ models.py
â”‚   â””â”€â”€ services.py            # CalculadoraDesconto
â”œâ”€â”€ posp2/                      # Terminal POS (OAuth)
â”‚   â”œâ”€â”€ services_transacao.py  # TRDataService
â”‚   â””â”€â”€ services_conta_digital.py # AutorizaÃ§Ã£o saldo
â”œâ”€â”€ pinbank/cargas_pinbank/     # Cargas automÃ¡ticas
â”‚   â”œâ”€â”€ services.py            # Extrato POS
â”‚   â””â”€â”€ services_ajustes_manuais.py
â”œâ”€â”€ portais/                    # 4 Portais web
â”‚   â”œâ”€â”€ controle_acesso/       # Multi-portal
â”‚   â”œâ”€â”€ admin/                 # 45+ templates
â”‚   â”œâ”€â”€ lojista/
â”‚   â””â”€â”€ vendas/                # Checkout + recorrÃªncias
â”œâ”€â”€ checkout/                   # Checkout core
â”‚   â”œâ”€â”€ models.py              # + 7 campos antifraude
â”‚   â”œâ”€â”€ services_antifraude.py # 268 linhas
â”‚   â”œâ”€â”€ link_pagamento_web/
â”‚   â””â”€â”€ link_recorrencia_web/
â”œâ”€â”€ sistema_bancario/           # Camada serviÃ§os
â”‚   â””â”€â”€ services.py            # PagamentoService
â””â”€â”€ comum/                      # Compartilhado
    â”œâ”€â”€ oauth/                 # OAuth 2.0
    â”œâ”€â”€ integracoes/           # WhatsApp, SMS, Push
    â”œâ”€â”€ middleware/            # SecurityValidation
    â”œâ”€â”€ seguranca/             # 2FA, Devices
    â””â”€â”€ estr_organizacional/   # Canal, Loja, Regional
```

### Risk Engine

```
wallclub-riskengine/
â”œâ”€â”€ antifraude/
â”‚   â”œâ”€â”€ models.py              # TransacaoRisco, Regras
â”‚   â”œâ”€â”€ services.py            # 5 regras antifraude
â”‚   â”œâ”€â”€ views_api.py           # REST APIs
â”‚   â”œâ”€â”€ views_revisao.py       # Portal admin
â”‚   â”œâ”€â”€ views_seguranca.py     # APIs seguranÃ§a
â”‚   â”œâ”€â”€ tasks.py               # 6 detectores Celery
â”‚   â””â”€â”€ notifications.py       # Email + Slack
â”œâ”€â”€ comum/oauth/               # OAuth independente
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ README.md             # Este documento
â”‚   â””â”€â”€ engine_antifraude.md  # Guia completo
â””â”€â”€ scripts/
    â”œâ”€â”€ seed_regras_antifraude.py
    â””â”€â”€ testar_maxmind_producao.py
```

---

## ğŸš€ DEPLOY

### Desenvolvimento Local

```bash
# Django
cd wallclub_django
docker-compose up --build

# Acesso
http://localhost:8005  # Portais (admin, vendas, lojista)
http://localhost:8007/api/v1/  # APIs Mobile
http://localhost:8006  # POS
```

### ProduÃ§Ã£o (5 Containers)

**Servidor:** AWS EC2 ubuntu@ip-10-0-1-46  
**ConfiguraÃ§Ã£o:** AWS Secrets Manager + IAM Role  
**Proxy:** Nginx + Gunicorn  

**Comandos:**
```bash
cd /var/www/wallclub_django

# Deploy completo
docker-compose down
docker-compose up -d --build

# Deploy seletivo
docker-compose up -d --build --no-deps web riskengine

# Status
docker-compose ps

# Logs
docker logs wallclub-prod-release300 --tail 100
docker logs wallclub-riskengine --tail 100
```

**Health Checks:**
```bash
# Django
curl http://localhost:8003/api/v1/health/

# Risk Engine
curl http://localhost:8004/api/antifraude/health/
```

### Recursos por Container

| Container | CPU | RAM | Porta | Workers |
|-----------|-----|-----|-------|---------|
| Django | 1.5 | 2GB | 8003 | 3 |
| Risk Engine | 0.5 | 512MB | 8004 | 3 |
| Redis | 0.25 | 256MB | 6379 | - |
| Celery Worker | 0.5 | 256MB | - | 4 |
| Celery Beat | 0.25 | 128MB | - | - |

---

## ğŸ”— INTEGRAÃ‡Ã•ES EXTERNAS

### Pinbank

**TransaÃ§Ãµes:**
- CartÃ£o direto: EfetuarTransacaoEncrypted
- CartÃ£o tokenizado: EfetuarTransacaoCartaoIdEncrypted
- TokenizaÃ§Ã£o: IncluirCartaoEncrypted

**Cargas:**
- Extrato POS (30min, 72h, 60d, ano)
- Base GestÃ£o (130+ variÃ¡veis)
- Credenciadora + Checkout

**Arquivos:** `pinbank/services_transacoes_pagamento.py`, `pinbank/cargas_pinbank/services.py`

### MaxMind minFraud

**Cache:** 1h (Redis)  
**Fallback:** Score neutro 50  
**Timeout:** 3s  
**Custo:** R$ 50-75/mÃªs  

**Arquivo:** `antifraude/services_maxmind.py`

### WhatsApp Business

**Templates dinÃ¢micos:**
- 2fa_login_app (AUTHENTICATION)
- senha_acesso (AUTHENTICATION)
- baixar_app (UTILITY)

**Categorias:**
- AUTHENTICATION: sempre entrega
- UTILITY: funcional
- MARKETING: requer opt-in

**Arquivo:** `comum/integracoes/whatsapp_service.py`

### Firebase + APN

**Firebase:** Android push  
**APN:** iOS (fallback produÃ§Ã£oâ†’sandbox)  
**Bundle ID:** DinÃ¢mico da tabela canal  

**Arquivos:** `comum/integracoes/firebase_service.py`, `comum/integracoes/apn_service.py`

### AWS Secrets Manager

**Secrets:**
- `wall/prod/db` - Credenciais BD + MaxMind
- OAuth clients separados (admin, pos, internal)

**ConfiguraÃ§Ã£o:** IAM Role no EC2

---

## ğŸ“Š PADRÃ•ES TÃ‰CNICOS

### Banco de Dados

**Collation obrigatÃ³ria:** utf8mb4_unicode_ci

```sql
-- Template CREATE
CREATE TABLE nome (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    campo VARCHAR(255) COLLATE utf8mb4_unicode_ci
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Converter existente
ALTER TABLE nome CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

**Timezone:** USE_TZ=False + TZ=America/Sao_Paulo

**Valores monetÃ¡rios:** SEMPRE Decimal (nunca float)

### APIs REST

**AutenticaÃ§Ã£o:**
- Mobile: JWT customizado (Bearer token)
- POS: OAuth 2.0 client_credentials
- Checkout: OAuth 2.0 + sessÃ£o temporÃ¡ria

**MÃ©todo:** SEMPRE POST (nunca GET/PUT/DELETE)

**Formato resposta:**
```json
{"sucesso": bool, "mensagem": str, ...}
```
NUNCA: `success`, `error`, `data`

### Logs

**NÃ­veis:**
- DEBUG: validaÃ§Ãµes OK, fluxo normal
- INFO: operaÃ§Ãµes concluÃ­das
- WARNING: validaÃ§Ãµes negadas, anomalias
- ERROR: exceÃ§Ãµes crÃ­ticas

**Categoria:** `comum.modulo` ou `apps.modulo`

### Nomenclatura

- VariÃ¡veis/funÃ§Ãµes: snake_case
- Classes: PascalCase
- Arquivos: snake_case.py
- Templates: snake_case.html

---

## ğŸ“š DOCUMENTAÃ‡ÃƒO COMPLEMENTAR

### Documentos Principais

- **[Django README (1117 linhas)](../2.%20README.md)** - Sistema completo detalhado
- **[Risk Engine README (839 linhas)](../../wallclub-riskengine/docs/README.md)** - Antifraude completo
- **[DIRETRIZES (3428 linhas)](../1.%20DIRETRIZES.md)** - PadrÃµes obrigatÃ³rios
- **[Risk Engine DIRETRIZES](../../wallclub-riskengine/docs/DIRETRIZES.md)** - PadrÃµes antifraude

### Documentos TÃ©cnicos

- `docs/TESTE_CURL_USUARIO.md` - Testes JWT (18 cenÃ¡rios)
- `docs/engine_antifraude.md` - Motor antifraude
- `docs/mudancas_login_app.md` - Sistema autenticaÃ§Ã£o
- `docs/fluxo_login_revalidacao.md` - Login simplificado
- `docs/4. sistema_checkout_completo.md` - Checkout detalhado
- `docs/0. deploy_simplificado.md` - Setup Docker

### Scripts

- `scripts/producao/` - MigraÃ§Ã£o, validaÃ§Ã£o, comparaÃ§Ã£o Django vs PHP
- `scripts/seed_regras_antifraude.py` - Seed regras Risk Engine
- `scripts/testar_maxmind_producao.py` - Teste MaxMind
- `curls_teste/checkout.txt` - Exemplos API

---

## ğŸ”„ FASE 6B - APIS REST INTERNAS (Em andamento)

### Status: 71% Completo (5/7 dias)

**Branch:** `multiplos_containers`  
**PerÃ­odo:** 28/10 - 08/11/2025  
**Objetivo:** Resolver dependÃªncias cruzadas via APIs REST

### Implementado:

#### 1. Middleware APIs Internas âœ…
- Path `/api/internal/*` sem rate limiting
- DiferenciaÃ§Ã£o automÃ¡tica interno vs externo
- Arquivo: `comum/middleware/security_middleware.py`

#### 2. APIs Conta Digital (5 endpoints) âœ…
**Base:** `/api/internal/conta_digital/`

- `POST /consultar_saldo/` - Consulta saldo por CPF
- `POST /calcular_maximo/` - Calcula valor mÃ¡ximo permitido
- `POST /autorizar_uso/` - Cria autorizaÃ§Ã£o e bloqueia saldo
- `POST /debitar_saldo/` - Debita apÃ³s transaÃ§Ã£o aprovada
- `POST /estornar_saldo/` - Estorna transaÃ§Ã£o cancelada

**Usado por:** posp2 (fluxo POS completo)

#### 3. APIs Checkout RecorrÃªncias (8 endpoints) âœ…
**Base:** `/api/internal/checkout/`

- CRUD completo de recorrÃªncias
- Pausar/reativar/cobrar manualmente
- Usado por portais Admin/Lojista

#### 4. Tasks Celery Movidas âœ…
- `portais/vendas/tasks_recorrencia.py` â†’ `checkout/tasks_recorrencia.py`
- Lazy imports para evitar dependÃªncias circulares
- Logger correto: `checkout.recorrencia`

### Commits Realizados:
- `c6f98d5` - Middleware ajustado
- `7416f3a` - 5 endpoints conta-digital
- `b9fae11` - Refatorar posp2 (usar APIs)
- `62ca51e` - Mover tasks recorrÃªncia
- `05c0b39` - 8 endpoints checkout
- `9439f64` - Fix consultar_saldo
- `63f4f07` - Fix calcular_maximo
- `3ec67df` - Fix autorizar_uso
- `bd2091a` - URLs underscore
- `6d1f13f` - Base path underscore

### Pendente (Dia 6-7):
- 8 endpoints checkout clientes/links
- Testes end-to-end completos

### Arquitetura Atual:
```
APP (Monolito)
â”œâ”€â”€ posp2/                    â†’ Chama APIs via HTTP
â”‚   â””â”€â”€ services_conta_digital.py (requests.post)
â”œâ”€â”€ apps/conta_digital/       â†’ Prove APIs
â”‚   â”œâ”€â”€ views_internal_api.py (5 endpoints)
â”‚   â””â”€â”€ urls_internal.py
â”œâ”€â”€ checkout/                 â†’ Prove APIs
â”‚   â”œâ”€â”€ views_internal_api.py (8 endpoints)
â”‚   â”œâ”€â”€ urls_internal.py
â”‚   â””â”€â”€ tasks_recorrencia.py (Celery)
â””â”€â”€ comum/middleware/
    â””â”€â”€ security_middleware.py (diferencia interno/externo)
```

**PrÃ³xima Fase 6C:** Extrair CORE em package compartilhado

---

## ğŸ“ SUPORTE

**ResponsÃ¡vel:** Jean Lessa + Claude AI  
**RepositÃ³rio Django:** `/var/www/wallclub_django`  
**RepositÃ³rio Risk Engine:** `/var/www/wallclub_django_risk_engine`  
**Ambiente:** AWS EC2 + Docker + MySQL + Redis  
**Status:** âœ… 100% operacional em produÃ§Ã£o

---

**Ãšltima atualizaÃ§Ã£o:** 02/11/2025  
**PrÃ³xima revisÃ£o:** Fase 6D (SeparaÃ§Ã£o fÃ­sica containers)
