# INTEGRA√á√ïES - WALLCLUB ECOSYSTEM

**Vers√£o:** 4.0  
**Data:** 05/11/2025  
**Status:** 4 containers independentes, 26 APIs internas, Fases 1-6 conclu√≠das  
**Mudan√ßas:** Sistema Multi-Portal, Checkout 2FA, Recorr√™ncias Celery, 9 regras antifraude

---

## üìã √çNDICE

### APIs Internas (Inter-Containers)
1. [APIs Internas - Overview](#apis-internas---overview) ‚≠ê NOVO
2. [Conta Digital APIs](#conta-digital-apis) ‚≠ê NOVO
3. [Checkout Recorr√™ncias APIs](#checkout-recorr√™ncias-apis) ‚≠ê NOVO
4. [Ofertas APIs](#ofertas-apis) ‚≠ê NOVO
5. [Par√¢metros APIs](#par√¢metros-apis) ‚≠ê NOVO

### Integra√ß√µes Externas
6. [Pinbank](#pinbank)
7. [MaxMind minFraud](#maxmind-minfraud)
8. [Risk Engine - Autentica√ß√£o Cliente](#risk-engine---autentica√ß√£o-cliente)
9. [WhatsApp Business](#whatsapp-business)
10. [SMS](#sms)
11. [Firebase Cloud Messaging](#firebase-cloud-messaging)
12. [Apple Push Notifications](#apple-push-notifications)
13. [AWS Secrets Manager](#aws-secrets-manager)
14. [Troubleshooting](#troubleshooting)

---

## üåê APIS INTERNAS - OVERVIEW

**Status:** Fase 6B conclu√≠da (01/11/2025) - Operacional em produ√ß√£o  
**Total:** 26 endpoints REST  
**Prop√≥sito:** Comunica√ß√£o entre 4 containers Django independentes

**Containers:**
- wallclub-portais (Admin, Vendas, Lojista)
- wallclub-pos (Terminal POS)
- wallclub-apis (Mobile + Checkout)
- wallclub-riskengine (Antifraude)

### Caracter√≠sticas

**Autentica√ß√£o:** OAuth 2.0 (scope `internal`)  
**Rate Limiting:** Desabilitado (containers confi√°veis)  
**Timeout:** 5s (consulta), 10s (escrita)  
**Base URL:** `http://wallclub-apis:8005/api/internal/` (rede Docker interna)

**Credenciais:** AWS Secrets Manager (`wall/prod/oauth/internal`)

### Distribui√ß√£o

| M√≥dulo | Endpoints | Finalidade |
|---------|-----------|------------|
| Conta Digital | 5 | Saldo, autoriza√ß√£o, d√©bito |
| Checkout Recorr√™ncias | 8 | CRUD + controle recorr√™ncias |
| Ofertas | 6 | CRUD ofertas + grupos |
| Par√¢metros | 7 | Configura√ß√µes lojas |

---

## üí≥ CONTA DIGITAL APIS (Fase 6B)

**Base:** `/api/internal/conta-digital/`  
**Arquivo:** `apps/conta_digital/views_internal_api.py`  
**Container:** wallclub-apis

### Endpoints Dispon√≠veis

1. `POST /consultar-saldo/` - Consulta saldo dispon√≠vel + bloqueado
2. `POST /autorizar-uso/` - Autoriza√ß√£o uso saldo (push app cliente)
3. `POST /debitar-saldo/` - D√©bito com lock pessimista
4. `POST /estornar-saldo/` - Estorno de d√©bito
5. `POST /calcular-maximo/` - C√°lculo valor m√°ximo dispon√≠vel

**Autentica√ß√£o:** OAuth 2.0 interno  
**Usado por:** POSP2 (Terminal POS)

---

## üîÅ CHECKOUT RECORRENCIAS APIS (Fase 5)

**Base:** `/api/internal/checkout/recorrencias/`  
**Arquivo:** `checkout/views_internal_api.py`  
**Container:** wallclub-apis

### Endpoints Dispon√≠veis

1. `GET /` - Listar recorr√™ncias (filtros: status, cliente, loja)
2. `POST /criar/` - Criar nova recorr√™ncia agendada
3. `GET /{id}/` - Obter detalhes de recorr√™ncia
4. `POST /{id}/pausar/` - Pausar cobran√ßas (status=pausado)
5. `POST /{id}/reativar/` - Reativar cobran√ßas (status=ativo)
6. `POST /{id}/cobrar/` - Executar cobran√ßa manual
7. `PUT /{id}/atualizar/` - Atualizar dados (valor, dia_cobranca)
8. `DELETE /{id}/deletar/` - Cancelar recorr√™ncia (status=cancelado)

**Autentica√ß√£o:** OAuth 2.0 interno  
**Usado por:** Portal Vendas, Celery Beat (cobran√ßas autom√°ticas)  
**Celery Task:** `processar_recorrencias_do_dia()` - executa diariamente √†s 08:00

---

## üéÅ OFERTAS APIS (Fase 3 + 6B)

**Base:** `/api/internal/ofertas/`  
**Arquivo:** `apps/ofertas/views_internal_api.py`  
**Container:** wallclub-apis

### Endpoints Dispon√≠veis

1. `POST /listar/` - Lista ofertas (filtros: canal, ativo, vig√™ncia)
2. `POST /criar/` - Cria nova oferta + upload imagem
3. `POST /obter/` - Obt√©m detalhes de oferta
4. `POST /atualizar/` - Atualiza oferta existente
5. `POST /grupos/listar/` - Lista grupos de segmenta√ß√£o
6. `POST /grupos/criar/` - Cria novo grupo customizado

**Autentica√ß√£o:** OAuth 2.0 interno  
**Usado por:** Portal Admin, Portal Lojista  
**Features:** Push notifications (Firebase + APN), segmenta√ß√£o din√¢mica

---

## ‚öôÔ∏è PARAMETROS APIS (Fase 0 + 6B)

**Base:** `/api/internal/parametros/`  
**Arquivo:** `parametros_wallclub/views_internal_api.py`  
**Container:** wallclub-pos

### Endpoints Dispon√≠veis

1. `POST /configuracoes/loja/` - Busca configura√ß√µes financeiras por loja
2. `POST /configuracoes/contar/` - Conta total de configura√ß√µes
3. `POST /configuracoes/ultima/` - Obt√©m √∫ltima configura√ß√£o ativa
4. `POST /loja/modalidades/` - Lista modalidades dispon√≠veis (PIX, D√âBITO, etc)
5. `POST /planos/` - Lista planos de parcelamento
6. `GET /importacoes/` - Lista importa√ß√µes de par√¢metros PHP‚ÜíDjango
7. `GET /importacoes/{id}/` - Detalhes de importa√ß√£o espec√≠fica

**Autentica√ß√£o:** OAuth 2.0 interno  
**Usado por:** POSP2, Portal Admin, Portal Lojista  
**Total:** 3.840 configura√ß√µes validadas 100% vs PHP

---

## üí≥ PINBANK (Gateway de Pagamentos)

### Vis√£o Geral

**Gateway de pagamentos** para transa√ß√µes cart√£o cr√©dito/d√©bito, tokeniza√ß√£o e cargas autom√°ticas.

**Ambiente:** Produ√ß√£o  
**Autentica√ß√£o:** Basic Auth (credenciais AWS Secrets Manager)  
**Timeout:** 30s transa√ß√µes, 60s cargas  
**Container:** wallclub-pos (POSP2) + wallclub-apis (Checkout)

**Integrado com:**
- ‚úÖ POSP2 (Terminal POS)
- ‚úÖ Checkout Web (Link Pagamento + Recorr√™ncias)
- ‚úÖ Portal Vendas
- ‚úÖ Risk Engine (an√°lise antes de processar)  

### APIs de Transa√ß√£o

#### 1. EfetuarTransacaoEncrypted

**Uso:** Pagamento com dados cart√£o direto (sem token)

**Endpoint:** `POST /PinPagSeguroController/EfetuarTransacaoEncrypted`

**Request:**
```json
{
  "CodigoCliente": 1234,
  "NumeroCartao": "5111111111111111",
  "NomeTitular": "JOSE SILVA",
  "MesValidade": "12",
  "AnoValidade": "28",
  "CVV": "123",
  "TipoTransacao": "CREDITO",
  "ValorTransacao": 110.50,
  "NumeroParcelas": 1,
  "UrlRetorno": "https://wcadmin.wallclub.com.br/callback/",
  "terminal": "12345678"
}
```

**Response:**
```json
{
  "Status": true,
  "NSU": "148456789",
  "CodigoAutorizacao": "ABC123",
  "Mensagem": "Transacao aprovada"
}
```

**Arquivo:** `pinbank/services_transacoes_pagamento.py`

#### 2. EfetuarTransacaoCartaoIdEncrypted

**Uso:** Pagamento com cart√£o tokenizado

**Diferen√ßas:**
- Usa `CartaoId` em vez de dados completos
- Mais seguro (PCI-DSS compliant)
- Mais r√°pido (sem digita√ß√£o)

**Request:**
```json
{
  "CodigoCliente": 1234,
  "CartaoId": "550e8400-e29b-41d4-a716-446655440000",
  "CVV": "123",
  "TipoTransacao": "CREDITO",
  "ValorTransacao": 110.50,
  "NumeroParcelas": 1
}
```

**Arquivo:** `pinbank/services_transacoes_pagamento.py`

#### 3. CapturarTransacaoEncrypted (Fase 5)

**Uso:** Captura de transa√ß√µes pr√©-autorizadas (recorr√™ncias)

**Endpoint:** `POST /Transacoes/CapturarTransacaoEncrypted`  
**Data Implementa√ß√£o:** 03/11/2025

**Fluxo:**
1. Efetuar transa√ß√£o com `TransacaoPreAutorizada=true` (reserva valor)
2. Capturar transa√ß√£o com NSU (efetiva cobran√ßa)

**Request:**
```json
{
  "CodigoCanal": 47,
  "CodigoCliente": 3510,
  "KeyLoja": "11384322623341877660",
  "Valor": 1000,
  "NsuOperacao": "136586937"
}
```

**Response:**
```json
{
  "ResultCode": 0,
  "Message": "Success",
  "Data": {
    "CodigoAutorizacaoCaptura": "343163"
  }
}
```

**Arquivo:** `pinbank/services_transacoes_pagamento.py` (m√©todo `capturar_transacao`)  
**Usado por:** Celery task `processar_recorrencias_do_dia()`

#### 4. CancelarTransacaoEncrypted

**Uso:** Estorno de transa√ß√µes (pr√©-autorizadas ou normais)

**Endpoint:** `POST /Transacoes/CancelarTransacaoEncrypted`

**Request:**
```json
{
  "CodigoCanal": 47,
  "CodigoCliente": 3510,
  "KeyLoja": "11384322623341877660",
  "Valor": 500,
  "NsuOperacao": "136586940"
}
```

**Response:**
```json
{
  "ResultCode": 0,
  "Message": "Success",
  "Data": {
    "CodigoAutorizacaoCancelamento": "775169"
  }
}
```

**Arquivo:** `pinbank/services_transacoes_pagamento.py` (m√©todo `cancelar_transacao`)

#### 5. IncluirCartaoEncrypted

**Uso:** Tokeniza√ß√£o de cart√µes para pagamentos futuros

**Request:**
```json
{
  "CodigoCliente": 1234,
  "CPF": "12345678900",
  "NumeroCartao": "5111111111111111",
  "NomeTitular": "JOSE SILVA",
  "MesValidade": "12",
  "AnoValidade": "28",
  "TipoCartao": "CREDITO"
}
```

**Response:**
```json
{
  "Status": true,
  "CartaoId": "550e8400-e29b-41d4-a716-446655440000",
  "UltimosDigitos": "1111",
  "Bandeira": "MASTERCARD"
}
```

**Arquivo:** `checkout/link_pagamento_web/services.py`, `portais/vendas/services_checkout.py`

### Cargas Autom√°ticas (Fase 0 + 3)

#### 1. Extrato POS

**Periodicidades:**
- **30min:** √öltimas 30 minutos (cron)
- **72h:** √öltimas 72 horas (manual)
- **60d:** √öltimos 60 dias (manual)
- **ano:** Ano corrente (manual)

**Command:** `python manage.py carga_extrato_pos`  
**Container:** wallclub-pos

**Tabelas:**
- `pinbank_extrato_pos` (staging)
- `transactiondata` (transa√ß√µes finais)

**Lock:** Impede execu√ß√£o paralela

**Erro:** `baseTransacoesGestaoErroCarga`

**Arquivo:** `pinbank/cargas_pinbank/services.py` (CargaExtratoPOSService)

#### 2. Base Gest√£o (TEF)

**Vari√°veis:** 130+ (var0-var130)  
**Streaming:** 100 registros/lote (otimiza√ß√£o mem√≥ria)  
**Command:** `python manage.py carga_base_gestao`  
**Tabela:** `baseTransacoesGestao`  
**Container:** wallclub-pos

**Calculadora:** Compartilhada com Credenciadora (1178 linhas)  
**Arquivo:** `parametros_wallclub/calculadora_base_gestao.py`

**Status:**
- 85 vari√°veis implementadas
- 46 vari√°veis faltantes documentadas (var93-130)

**Corre√ß√µes Fase 3 (25/10/2025):**
- ‚úÖ Bug √∫ltimo lote (<100 registros) corrigido
- ‚úÖ Queries duplicadas eliminadas (info_loja/info_canal)
- ‚úÖ Sobrescrita de vari√°veis corrigida (var45 preservado)
- ‚úÖ Data pagamento imut√°vel implementada

**Arquivo:** `parametros_wallclub/calculadora_base_gestao.py` (compartilhado)

#### 3. Carga Credenciadora

**Fonte:** Arquivo credenciadora

**Normaliza√ß√£o:** 
- `tipo_operacao` padronizado
- `codigoCliente` camelCase
- `info_loja`/`info_canal` montados localmente

**Command:** `python manage.py carga_credenciadora`

**Bug corrigido (25/10):** √öltimo lote <100 registros

**Arquivo:** `pinbank/cargas_pinbank/services_carga_credenciadora.py`

#### 4. Carga Checkout

**Fonte:** Arquivo checkout web

**Command:** `python manage.py carga_checkout`

**Mesmas regras:** Credenciadora

**Arquivo:** `pinbank/cargas_pinbank/services_carga_checkout.py`

### Ajustes Manuais

**Service:** `AjustesManuaisService`

**Opera√ß√µes:**
- Inser√ß√µes faltantes: `transactiondata` via cruzamento
- Remo√ß√µes duplicatas: `baseTransacoesGestao` sem `idFilaExtrato`

**M√©todo:** Queries SQL diretas com auditoria

**Arquivo:** `pinbank/cargas_pinbank/services_ajustes_manuais.py`

### Tratamento de Erros

**Timeout:**
```python
try:
    response = requests.post(url, json=payload, timeout=30)
except requests.Timeout:
    return {'sucesso': False, 'mensagem': 'Timeout Pinbank'}
```

**Respostas Inv√°lidas:**
```python
if not response_data.get('Status'):
    mensagem = response_data.get('Mensagem', 'Erro desconhecido')
    return {'sucesso': False, 'mensagem': mensagem}
```

---

## üåç MAXMIND MINFRAUD (Fase 2)

### Vis√£o Geral

**Servi√ßo:** An√°lise de risco score 0-100  
**Status:** Operacional desde 17/10/2025  
**Container:** wallclub-riskengine

**Cache:** Redis 1h (chave: `maxmind:{cpf}:{valor}:{ip}`)  
**Timeout:** 3s  
**Fallback:** Score neutro 50 (fail-safe)  
**Custo:** R$ 70-120/m√™s (validado em produ√ß√£o)

**Hit Rate Cache:** >90% (reduz 90% das chamadas API)

### Configura√ß√£o

**Credenciais:** AWS Secrets Manager (`wall/prod/db`)  
**Migra√ß√£o:** 17/10/2025 - Removido do .env

```json
{
  "MAXMIND_ACCOUNT_ID": "123456",
  "MAXMIND_LICENSE_KEY": "abc123..."
}
```

**Valida√ß√£o Produ√ß√£o:**
```bash
docker exec wallclub-riskengine python scripts/testar_maxmind_producao.py
# Score: 1/100, fonte: maxmind, tempo: 92ms ‚úÖ
```

**Settings:**
```python
MAXMIND_ACCOUNT_ID = secrets.get('MAXMIND_ACCOUNT_ID')
MAXMIND_LICENSE_KEY = secrets.get('MAXMIND_LICENSE_KEY')
```

### Uso

**Arquivo:** `antifraude/services_maxmind.py` (Risk Engine)

**M√©todo:**
```python
from antifraude.services_maxmind import MaxMindService

score = MaxMindService.get_score(
    cpf='12345678900',
    ip='192.168.1.100',
    valor=150.00,
    email='cliente@email.com'
)
# score = 0-100 (ou 50 se falha)
```

### Cache Redis

**TTL:** 3600s (1 hora)

**Reduz:** 90% das chamadas API

**Exemplo:**
```python
cache_key = f"maxmind:{cpf}:{valor}:{ip}"
cached_score = redis.get(cache_key)

if cached_score:
    return int(cached_score)

# Chamar API MaxMind
score = api_call()
redis.setex(cache_key, 3600, score)
```

### Fallback Autom√°tico

**Score neutro 50 quando:**
- Credenciais n√£o configuradas
- Timeout (>3s)
- Erro HTTP (4xx, 5xx)
- Exce√ß√£o inesperada

**Princ√≠pio:** Sistema NUNCA bloqueia por falha t√©cnica

**Log:**
```python
logger.warning(f"‚ö†Ô∏è MaxMind indispon√≠vel, usando score neutro 50")
```

### Teste em Produ√ß√£o

**Script:** `scripts/testar_maxmind_producao.py`

```bash
docker exec wallclub-riskengine python scripts/testar_maxmind_producao.py
```

**Valida:**
- Credenciais corretas
- Resposta API 200
- Score entre 0-100
- Cache funcionando

---

## üí¨ WHATSAPP BUSINESS

### Vis√£o Geral

**Plataforma:** Meta Business API

**Autentica√ß√£o:** Bearer token (AWS Secrets)

**Templates:** Din√¢micos do banco (`templates_envio_msg`)

**Categorias:**
- AUTHENTICATION: sempre entrega
- UTILITY: funcional
- MARKETING: requer opt-in

### Templates Ativos

| Template | Categoria | Par√¢metros | Uso |
|----------|-----------|------------|-----|
| 2fa_login_app | AUTHENTICATION | c√≥digo | Login 2FA |
| senha_acesso | AUTHENTICATION | c√≥digo | Reset senha |
| baixar_app | UTILITY | nome, link | Onboarding |
| autorizacao_saldo | UTILITY | valor, loja | Autoriza√ß√£o cashback |

### Estrutura Template

**Banco de dados:**
```sql
CREATE TABLE templates_envio_msg (
  id BIGINT PRIMARY KEY,
  meio VARCHAR(50),  -- 'whatsapp'
  tipo VARCHAR(50),  -- 'authentication', 'utility'
  nome_template VARCHAR(100),
  template_id VARCHAR(100),
  parametros JSON,  -- ["{{1}}", "{{2}}"]
  corpo_template TEXT
);
```

### Envio de Mensagem

**Arquivo:** `comum/integracoes/whatsapp_service.py`

**M√©todo:**
```python
from comum.integracoes.whatsapp_service import WhatsAppService

resultado = WhatsAppService.enviar_template(
    telefone='5511999887766',
    template_name='2fa_login_app',
    parametros=['123456']  # C√≥digo OTP
)

if resultado['sucesso']:
    message_id = resultado['message_id']
```

**Request API:**
```json
{
  "messaging_product": "whatsapp",
  "to": "5511999887766",
  "type": "template",
  "template": {
    "name": "2fa_login_app",
    "language": {
      "code": "pt_BR"
    },
    "components": [
      {
        "type": "body",
        "parameters": [
          {"type": "text", "text": "123456"}
        ]
      }
    ]
  }
}
```

### Tratamento de Erros

**Timeout:**
```python
try:
    response = requests.post(url, json=payload, timeout=10)
except requests.Timeout:
    logger.error("‚è±Ô∏è Timeout WhatsApp")
    return {'sucesso': False, 'mensagem': 'Timeout'}
```

**Erro API:**
```python
if response.status_code != 200:
    error = response.json().get('error', {})
    logger.error(f"‚ùå WhatsApp error: {error}")
    return {'sucesso': False, 'mensagem': error.get('message')}
```

**Fail-safe:** OTP sempre retorna sucesso (n√£o bloqueia fluxo)

---

## üì± SMS

### Vis√£o Geral

**Provedor:** Gateway SMS customizado

**Formato URL:**
```
/TELEFONE/MENSAGEM/SHORTCODE/ASSUNTO
```

**Encoding:** `quote(mensagem, safe=':/')`

### URL Encoding Correto (24/10/2025)

‚ùå **ERRADO:** Codifica tudo
```python
mensagem_encoded = quote(mensagem, safe='')
# Resultado: https:%2F%2Ftinyurl.com%2Fabc
```

‚úÖ **CORRETO:** Preserva URLs
```python
mensagem_encoded = quote(mensagem, safe=':/')
# Resultado: https://tinyurl.com/abc
```

**Motivo:** URLs em mensagens SMS devem permanecer clic√°veis

### Envio

**Arquivo:** `comum/integracoes/sms_service.py`

**M√©todo:**
```python
from comum.integracoes.sms_service import SMSService

resultado = SMSService.enviar_sms(
    telefone='5511999887766',
    mensagem='Seu c√≥digo √©: 1234. Link: https://app.wallclub.com.br/auth',
    shortcode='WALLCLUB',
    assunto='Autenticacao'
)
```

**URL Final:**
```
https://api-sms.com/5511999887766/Seu%20c%C3%B3digo%20%C3%A9%3A%201234.%20Link%3A%20https://app.wallclub.com.br/auth/WALLCLUB/Autenticacao
```

### Rate Limiting

**Por telefone:**
- 3 SMS/5min
- 5 SMS/1h
- 10 SMS/24h

**Redis:**
```python
key = f"sms_rate:{telefone}"
count = redis.incr(key)
if count == 1:
    redis.expire(key, 300)  # 5min
```

---

## üîî FIREBASE CLOUD MESSAGING

### Vis√£o Geral

**Plataforma:** Firebase (Android push)

**Autentica√ß√£o:** Service Account JSON (AWS Secrets)

**Payload:**
```json
{
  "message": {
    "token": "device_token_here",
    "notification": {
      "title": "T√≠tulo",
      "body": "Mensagem"
    },
    "data": {
      "tipo": "oferta",
      "oferta_id": "123"
    }
  }
}
```

### Configura√ß√£o

**Service Account:** AWS Secrets Manager

```json
{
  "type": "service_account",
  "project_id": "wallclub-app",
  "private_key_id": "...",
  "private_key": "...",
  "client_email": "firebase-adminsdk@wallclub-app.iam.gserviceaccount.com"
}
```

### Envio

**Arquivo:** `comum/integracoes/firebase_service.py`

**M√©todo:**
```python
from comum.integracoes.firebase_service import FirebaseService

resultado = FirebaseService.send_push(
    token='device_token',
    title='Nova oferta!',
    body='Desconto de 20% em todos produtos',
    custom_data={
        'tipo': 'oferta',
        'oferta_id': '123'
    }
)
```

### Custom Data

**Uso no app:**
```kotlin
// Android - Receber custom data
remoteMessage.data.forEach { (key, value) ->
    when(key) {
        "tipo" -> handleTipo(value)
        "oferta_id" -> openOferta(value)
    }
}
```

### Tratamento

**Token inv√°lido:**
```python
if 'INVALID_ARGUMENT' in error_message:
    # Remover token do banco
    DispositivoConfiavel.objects.filter(
        push_token=token
    ).delete()
```

---

## üçé APPLE PUSH NOTIFICATIONS

### Vis√£o Geral

**Plataforma:** APNs (iOS push)

**Autentica√ß√£o:** Token JWT + Team ID + Key ID

**Certificados:** `.p8` file (AWS Secrets)

### Configura√ß√£o

**Bundle IDs:** Din√¢micos da tabela `canal`

```sql
SELECT bundle_id FROM canal WHERE id = 1;
-- br.com.wallclub.app
```

**Settings:**
```python
APN_TEAM_ID = secrets.get('APN_TEAM_ID')
APN_KEY_ID = secrets.get('APN_KEY_ID')
APN_AUTH_KEY = secrets.get('APN_AUTH_KEY')  # .p8 content
```

### Fallback Autom√°tico (24/10/2025)

**Problema:** Certificado produ√ß√£o pode falhar

**Solu√ß√£o:** Tentar sandbox automaticamente

```python
try:
    # Tentar produ√ß√£o
    client = APNsClient(credentials, use_sandbox=False)
    client.send_notification(token, payload)
except Exception:
    # Fallback sandbox
    client = APNsClient(credentials, use_sandbox=True)
    client.send_notification(token, payload)
```

### Envio

**Arquivo:** `comum/integracoes/apn_service.py`

**M√©todo:**
```python
from comum.integracoes.apn_service import APNService

resultado = APNService.send_push(
    token='device_token_hex',
    title='Nova oferta!',
    body='Desconto de 20% em todos produtos',
    badge=1,
    sound='default',
    custom_data={
        'tipo': 'oferta',
        'oferta_id': '123'
    },
    bundle_id='br.com.wallclub.app'
)
```

### Payload

**Estrutura:**
```json
{
  "aps": {
    "alert": {
      "title": "Nova oferta!",
      "body": "Desconto de 20%"
    },
    "badge": 1,
    "sound": "default",
    "category": "oferta"
  },
  "tipo": "oferta",
  "oferta_id": "123"
}
```

### Category Din√¢mica (24/10/2025)

‚ùå **ERRADO:** Hardcode
```python
payload["aps"]["category"] = "AUTORIZACAO_SALDO"
```

‚úÖ **CORRETO:** Din√¢mico do template
```python
template = TemplateEnvioMsg.objects.get(nome='autorizacao_saldo')
payload["aps"]["category"] = template.tipo_push
```

---

## üîê AWS SECRETS MANAGER

### Vis√£o Geral

**Servi√ßo:** Armazenamento seguro de credenciais

**Autentica√ß√£o:** IAM Role no EC2 (sem access keys)

**Regi√£o:** us-east-1

### Secrets Ativos

**1. wall/prod/db**
```json
{
  "DB_NAME": "wallclub",
  "DB_USER": "root",
  "DB_PASSWORD": "...",
  "DB_HOST": "mysql",
  "DB_PORT": "3306",
  "MAXMIND_ACCOUNT_ID": "123456",
  "MAXMIND_LICENSE_KEY": "..."
}
```

**2. wall/prod/oauth/admin**
```json
{
  "CLIENT_ID": "wallclub_admin_portal",
  "CLIENT_SECRET": "..."
}
```

**3. wall/prod/oauth/pos**
```json
{
  "CLIENT_ID": "wallclub_pos_terminal",
  "CLIENT_SECRET": "..."
}
```

**4. wall/prod/integrations**
```json
{
  "WHATSAPP_TOKEN": "...",
  "FIREBASE_SERVICE_ACCOUNT": {...},
  "APN_TEAM_ID": "...",
  "APN_KEY_ID": "...",
  "APN_AUTH_KEY": "..."
}
```

### Uso no Django

**Arquivo:** `wallclub/settings/base.py`

```python
import boto3
import json

def get_secret(secret_name):
    client = boto3.client('secretsmanager', region_name='us-east-1')
    response = client.get_secret_value(SecretId=secret_name)
    return json.loads(response['SecretString'])

# Database
db_secrets = get_secret('wall/prod/db')
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': db_secrets['DB_NAME'],
        'USER': db_secrets['DB_USER'],
        'PASSWORD': db_secrets['DB_PASSWORD'],
        'HOST': db_secrets['DB_HOST'],
        'PORT': db_secrets['DB_PORT'],
    }
}

# MaxMind
MAXMIND_ACCOUNT_ID = db_secrets.get('MAXMIND_ACCOUNT_ID')
MAXMIND_LICENSE_KEY = db_secrets.get('MAXMIND_LICENSE_KEY')
```

### IAM Role

**Policy:** `AWSSecretsManagerReadWrite`

**Attached to:** EC2 instance

**Benef√≠cio:** Sem credenciais hardcoded

---

## üîß TROUBLESHOOTING

### Pinbank

**Timeout frequente:**
```bash
# Verificar conectividade
curl -X POST https://api.pinbank.com.br/health -m 5

# Aumentar timeout
PINBANK_TIMEOUT=60  # Em settings
```

**NSU duplicado:**
```sql
-- Verificar duplicatas
SELECT nsu, COUNT(*) 
FROM transactiondata 
GROUP BY nsu 
HAVING COUNT(*) > 1;
```

### MaxMind

**Score sempre 50:**
```bash
# Testar credenciais
docker exec wallclub-riskengine python scripts/testar_maxmind_producao.py

# Verificar cache
docker exec wallclub-redis redis-cli
> KEYS maxmind:*
> GET maxmind:12345678900:100.00:192.168.1.1
```

**Custo alto:**
```bash
# Ver hit rate cache
docker exec wallclub-redis redis-cli INFO stats | grep keyspace_hits
```

### WhatsApp

**Template rejeitado:**
- Verificar categoria correta (AUTHENTICATION vs UTILITY)
- Templates MARKETING precisam opt-in pr√©vio
- Par√¢metros devem corresponder ao template

**Mensagem n√£o entrega:**
```bash
# Verificar logs
docker logs wallclub-prod-release300 | grep whatsapp

# Status do n√∫mero
curl -X GET "https://graph.facebook.com/v18.0/PHONE_NUMBER_ID" \
  -H "Authorization: Bearer TOKEN"
```

### Firebase

**Token inv√°lido:**
```sql
-- Limpar tokens antigos
UPDATE otp_dispositivo_confiavel 
SET push_token = NULL 
WHERE last_used < NOW() - INTERVAL 90 DAY;
```

**Service account inv√°lido:**
```bash
# Validar JSON
cat firebase_service_account.json | jq .

# Testar credenciais
python -c "import firebase_admin; firebase_admin.initialize_app()"
```

### APN

**Certificado produ√ß√£o falha:**
- Fallback sandbox autom√°tico ativo (24/10)
- Verificar bundle ID correto do canal
- Certificado `.p8` v√°lido por 1 ano

**Token hex inv√°lido:**
```python
# Token deve ser 64 caracteres hex
assert len(token) == 64
assert all(c in '0123456789abcdef' for c in token.lower())
```

---

## üìä MONITORAMENTO

### M√©tricas Importantes

**Pinbank:**
- Taxa de sucesso transa√ß√µes: >95%
- Tempo m√©dio resposta: <2s
- Cargas conclu√≠das: 4/4 di√°rias

**MaxMind:**
- Hit rate cache: >90%
- Lat√™ncia m√©dia: <300ms
- Fallback rate: <5%

**Push Notifications:**
- Taxa de entrega: >80%
- Tokens inv√°lidos: <10%
- Tempo envio: <1s

### Logs √öteis

```bash
# Todas integra√ß√µes
docker logs wallclub-prod-release300 | grep -E "pinbank|maxmind|whatsapp|firebase|apn"

# Erros espec√≠ficos
docker logs wallclub-prod-release300 | grep ERROR | grep -i pinbank

# Rate de sucesso
docker logs wallclub-prod-release300 | grep "‚úÖ" | wc -l
```

---

---

## üõ°Ô∏è RISK ENGINE - AUTENTICA√á√ÉO CLIENTE

### Vis√£o Geral

**Servi√ßo:** An√°lise de comportamento de autentica√ß√£o para score antifraude

**Score:** 0-50 pontos (somado ao score total)

**Endpoint:** Django WallClub (OAuth exclusivo Risk Engine)

**Timeout:** 2s

**Fallback:** Score 0 (n√£o penaliza cliente em caso de erro)

**Data:** 30/10/2025

### Configura√ß√£o

**Autentica√ß√£o:** OAuth 2.0 exclusivo (`@require_oauth_riskengine`)

**Credenciais:** AWS Secrets Manager

```json
{
  "RISK_ENGINE_INTERNAL_CLIENT_ID": "wallclub_django_internal",
  "RISK_ENGINE_INTERNAL_CLIENT_SECRET": "..."
}
```

**URL Base:** `http://wallclub-portais:8005`

### Endpoint

**M√©todo:** `GET /cliente/api/v1/autenticacao/analise/<cpf>/`

**Autentica√ß√£o:** Bearer token OAuth 2.0

**Arquivo Django:** `apps/cliente/views_autenticacao_analise.py`

**Service:** `apps/cliente/services_autenticacao_analise.py`

**Arquivo Risk Engine:** `antifraude/services_cliente_auth.py`

### Request

```bash
curl -X GET "http://wallclub-portais:8005/cliente/api/v1/autenticacao/analise/12345678900/" \
  -H "Authorization: Bearer <oauth_token>"
```

### Response

**Sucesso (200):**
```json
{
  "cpf": "12345678900",
  "status_atual": {
    "conta_bloqueada": false,
    "tentativas_login_falhas": 2,
    "ultima_tentativa_falha": "2025-10-30T10:30:00"
  },
  "historico_24h": {
    "total_tentativas": 5,
    "tentativas_falhas": 2,
    "taxa_falha": 0.40,
    "ips_distintos": 2,
    "devices_distintos": 1
  },
  "dispositivos": {
    "total_conhecidos": 3,
    "confiaveis": 2,
    "novos_ultimos_7_dias": 1
  },
  "bloqueios_historico": {
    "total_30_dias": 0,
    "bloqueio_recente_7_dias": false,
    "ultimo_bloqueio": null
  },
  "flags_risco": {
    "conta_bloqueada": false,
    "bloqueio_recente": false,
    "multiplos_bloqueios": false,
    "alta_taxa_falha": true,
    "multiplas_tentativas_falhas": false,
    "multiplos_ips": false,
    "multiplos_devices": false,
    "todos_devices_novos": false,
    "sem_device_confiavel": false
  },
  "score_autenticacao": 15,
  "timestamp": "2025-10-30T10:45:00"
}
```

**Erro (404):**
```json
{
  "erro": "Cliente n√£o encontrado",
  "cpf": "12345678900"
}
```

### Dados Retornados

#### Status Atual
- `conta_bloqueada`: Se cliente est√° bloqueado atualmente
- `tentativas_login_falhas`: Total de tentativas falhas registradas
- `ultima_tentativa_falha`: Timestamp da √∫ltima falha

#### Hist√≥rico 24h
- `total_tentativas`: Total de tentativas de login
- `tentativas_falhas`: Tentativas que falharam
- `taxa_falha`: Percentual de falha (0.0 a 1.0)
- `ips_distintos`: Quantidade de IPs diferentes
- `devices_distintos`: Quantidade de dispositivos diferentes

#### Dispositivos
- `total_conhecidos`: Total de devices j√° usados
- `confiaveis`: Devices com 10+ logins bem-sucedidos
- `novos_ultimos_7_dias`: Devices cadastrados recentemente

#### Bloqueios Hist√≥rico
- `total_30_dias`: Bloqueios nos √∫ltimos 30 dias
- `bloqueio_recente_7_dias`: Teve bloqueio na √∫ltima semana
- `ultimo_bloqueio`: Data do √∫ltimo bloqueio

### Flags de Risco (9 flags)

| Flag | Descri√ß√£o | Pontua√ß√£o |
|------|-----------|----------|
| `conta_bloqueada` | Conta atualmente bloqueada | +30 |
| `bloqueio_recente` | Bloqueio nos √∫ltimos 7 dias | +20 |
| `multiplos_bloqueios` | 2+ bloqueios em 30 dias | +15 |
| `alta_taxa_falha` | Taxa de falha ‚â•30% | +15 |
| `multiplas_tentativas_falhas` | 5+ falhas em 24h | +10 |
| `multiplos_ips` | 3+ IPs distintos em 24h | +10 |
| `multiplos_devices` | 2+ devices distintos em 24h | +10 |
| `todos_devices_novos` | Todos devices <7 dias | +10 |
| `sem_device_confiavel` | Nenhum device com 10+ logins | +5 |

### Score de Autentica√ß√£o (0-50)

**C√°lculo:** Soma dos pontos das flags ativadas (m√°ximo 50)

**Exemplos:**

1. **Cliente Normal (Score 0):**
   - Sem bloqueios
   - Taxa falha <30%
   - Device confi√°vel
   - Score: 0 pontos

2. **Cliente Suspeito (Score 25):**
   - Alta taxa falha: +15
   - M√∫ltiplos IPs: +10
   - Score: 25 pontos

3. **Cliente Cr√≠tico (Score 50):**
   - Conta bloqueada: +30
   - Bloqueio recente: +20
   - Score: 50 pontos (m√°ximo)

### Integra√ß√£o AnaliseRiscoService

**Arquivo:** `antifraude/services.py`

**Fluxo:**
```python
# 1. Consultar endpoint Django
score_auth = ClienteAutenticacaoService.obter_score_autenticacao(cpf)

# 2. Somar ao score total
score_total += score_auth  # 0-50 pontos

# 3. Aplicar regras de autentica√ß√£o
if score_auth >= 30:
    regras_acionadas.append('Cliente com Bloqueio Recente')
```

**Configura√ß√µes Centralizadas:**
```python
# Tabela: antifraude_configuracao
AUTH_MAX_TENTATIVAS_FALHAS_24H = 5
AUTH_TAXA_FALHA_SUSPEITA = 0.3
AUTH_DIAS_ULTIMO_BLOQUEIO = 7
AUTH_MAX_BLOQUEIOS_30_DIAS = 2
AUTH_MAX_IPS_DISTINTOS_24H = 3
AUTH_MAX_DEVICES_DISTINTOS_24H = 2
CONSULTA_AUTH_TIMEOUT_SEGUNDOS = 2
```

### 4 Regras Novas Criadas

**1. Dispositivo Novo - Alto Valor** (Peso 7)
```python
{
  "nome": "Dispositivo Novo - Alto Valor",
  "parametros": {
    "device_age_days": 7,
    "valor_minimo": 500.0
  },
  "peso": 7,
  "acao": "REVISAR"
}
```

**2. IP Novo + Hist√≥rico de Bloqueios** (Peso 8)
```python
{
  "nome": "IP Novo + Hist√≥rico de Bloqueios",
  "parametros": {
    "ip_age_days": 3,
    "bloqueios_ultimos_30_dias": 2
  },
  "peso": 8,
  "acao": "REVISAR"
}
```

**3. M√∫ltiplas Tentativas Falhas Recentes** (Peso 6)
```python
{
  "nome": "M√∫ltiplas Tentativas Falhas Recentes",
  "parametros": {
    "tentativas_falhas_24h": 5,
    "taxa_falha_minima": 0.3
  },
  "peso": 6,
  "acao": "REVISAR"
}
```

**4. Cliente com Bloqueio Recente** (Peso 9)
```python
{
  "nome": "Cliente com Bloqueio Recente",
  "parametros": {
    "dias_desde_ultimo_bloqueio": 7
  },
  "peso": 9,
  "acao": "REVISAR"
}
```

### Tratamento de Erros

**Timeout:**
```python
try:
    response = requests.get(url, timeout=2)
except requests.Timeout:
    logger.warning("‚è±Ô∏è Timeout consulta autentica√ß√£o")
    return {'score_autenticacao': 0}  # N√£o penaliza
```

**Cliente n√£o encontrado:**
```python
if response.status_code == 404:
    logger.info(f"‚ÑπÔ∏è Cliente {cpf} n√£o encontrado")
    return {'score_autenticacao': 0}  # N√£o penaliza
```

**Erro interno:**
```python
if response.status_code >= 500:
    logger.error(f"‚ùå Erro servidor: {response.status_code}")
    return {'score_autenticacao': 0}  # Fail-safe
```

**Princ√≠pio:** Sistema NUNCA penaliza cliente por falha t√©cnica

### Tabelas Consultadas

**Django WallClub:**
- `cliente` - Dados b√°sicos e status bloqueio
- `cliente_autenticacao` - Tentativas de login (24h)
- `cliente_bloqueios` - Hist√≥rico de bloqueios (30 dias)
- `otp_dispositivo_confiavel` - Dispositivos conhecidos

**√çndices Importantes:**
```sql
-- Performance cr√≠tica
CREATE INDEX idx_cliente_autenticacao_cpf_data 
  ON cliente_autenticacao(cpf, data_tentativa);

CREATE INDEX idx_cliente_bloqueios_cpf_data 
  ON cliente_bloqueios(cpf, data_bloqueio);

CREATE INDEX idx_dispositivo_user_ativo 
  ON otp_dispositivo_confiavel(user_id, ativo, created_at);
```

### Cache

**N√£o utiliza cache** (dados precisam ser em tempo real)

**Motivo:** Comportamento de autentica√ß√£o muda rapidamente

### Teste em Produ√ß√£o

**Script manual:**
```bash
# 1. Obter token OAuth
TOKEN=$(curl -X POST http://wallclub-riskengine:8004/oauth/token/ \
  -d "grant_type=client_credentials" \
  -d "client_id=wallclub_django_internal" \
  -d "client_secret=SECRET" \
  | jq -r '.access_token')

# 2. Consultar an√°lise
curl -X GET "http://wallclub-prod-release300:8003/cliente/api/v1/autenticacao/analise/12345678900/" \
  -H "Authorization: Bearer $TOKEN" | jq .
```

**Valida:**
- Autentica√ß√£o OAuth funcionando
- Response 200 com estrutura correta
- Flags calculadas adequadamente
- Score entre 0-50

---

## üîó APIs REST INTERNAS (Fase 6B)

### Vis√£o Geral

**Comunica√ß√£o entre containers** para prepara√ß√£o da separa√ß√£o f√≠sica.

**Ambiente:** Produ√ß√£o  
**Autentica√ß√£o:** Sem rate limiting (middleware interno)  
**Base URL:** `http://127.0.0.1:8005` (mesmo container portais)  
**Status:** üü¢ Operacional (13 endpoints)

### APIs Conta Digital

**Base Path:** `/api/internal/conta_digital/`

#### 1. Consultar Saldo

**Endpoint:** `POST /api/internal/conta_digital/consultar_saldo/`

**Request:**
```json
{
  "cpf": "12345678900",
  "canal_id": 1
}
```

**Response:**
```json
{
  "sucesso": true,
  "tem_saldo": true,
  "saldo_disponivel": "150.50",
  "saldo_bloqueado": "0.00",
  "valor_maximo_permitido": "150.50"
}
```

**Usado por:** posp2 (valida√ß√£o POS)

#### 2. Calcular M√°ximo Permitido

**Endpoint:** `POST /api/internal/conta_digital/calcular_maximo/`

**Request:**
```json
{
  "cpf": "12345678900",
  "canal_id": 1,
  "loja_id": 1,
  "valor_transacao": "200.00"
}
```

**Response:**
```json
{
  "sucesso": true,
  "valor_maximo_permitido": "10.00",
  "percentual_permitido": "5.00"
}
```

**Usado por:** posp2 (c√°lculo cashback)

#### 3. Autorizar Uso

**Endpoint:** `POST /api/internal/conta_digital/autorizar_uso/`

**Request:**
```json
{
  "cpf": "12345678900",
  "canal_id": 1,
  "valor": "50.00",
  "loja_id": 1,
  "terminal_id": "PB59237K70569"
}
```

**Response:**
```json
{
  "sucesso": true,
  "autorizacao_id": "AUTH123456",
  "status": "APROVADO",
  "valor_bloqueado": "50.00"
}
```

**Usado por:** posp2 (autoriza√ß√£o de uso de saldo)

#### 4. Debitar Saldo

**Endpoint:** `POST /api/internal/conta_digital/debitar_saldo/`

**Usado ap√≥s:** Transa√ß√£o aprovada

#### 5. Estornar Saldo

**Endpoint:** `POST /api/internal/conta_digital/estornar_saldo/`

**Usado ap√≥s:** Transa√ß√£o cancelada/estornada

### APIs Checkout Recorr√™ncias

**Base Path:** `/api/internal/checkout/`

**Endpoints (8 total):**
- `GET /recorrencias/` - Listar com filtros
- `POST /recorrencias/criar/` - Criar nova
- `GET /recorrencias/{id}/` - Obter detalhes
- `POST /recorrencias/{id}/pausar/` - Pausar cobran√ßas
- `POST /recorrencias/{id}/reativar/` - Reativar
- `POST /recorrencias/{id}/cobrar/` - Cobrar manualmente
- `PUT /recorrencias/{id}/atualizar/` - Atualizar dados
- `DELETE /recorrencias/{id}/deletar/` - Cancelar

**Usado por:** Portais Admin/Lojista (gest√£o de recorr√™ncias)

### Middleware Diferenciado

**Path `/api/internal/*`:**
- ‚ùå Sem rate limiting
- ‚ùå Sem autentica√ß√£o OAuth (por enquanto)
- ‚úÖ Timeout 5-10s
- ‚úÖ Logs detalhados

**Arquivo:** `comum/middleware/security_middleware.py`

### Pr√≥ximos Passos (Fase 6D)

Quando containers forem separados fisicamente:
1. Alterar `INTERNAL_API_BASE_URL` nos .env
2. Adicionar autentica√ß√£o OAuth Client Credentials
3. Configurar rede Docker interna
4. Adicionar health checks

**URLs finais:**
- APP2 (POS): `http://wallclub-pos:8002`
- APP3 (APIs): `http://wallclub-apis:8003`

---

**√öltima atualiza√ß√£o:** 01/11/2025  
**Manuten√ß√£o:** Jean Lessa + Claude AI
