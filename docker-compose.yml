version: '3.8'

services:
  # Nginx - Gateway (Ãºnica porta externa)
  nginx:
    build:
      context: .
      dockerfile: Dockerfile.nginx
    container_name: nginx
    ports:
      - "8005:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./services/django/staticfiles:/staticfiles:ro
      - ./services/django/media:/media:ro
    depends_on:
      - wallclub-portais
      - wallclub-pos
      - wallclub-apis
      - wallclub-riskengine
    restart: unless-stopped
    networks:
      - wallclub-network

  # Redis - Cache e Broker do Celery
  redis:
    image: redis:7-alpine
    container_name: wallclub-redis
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    restart: unless-stopped
    networks:
      - wallclub-network

  # Container 1: Portais (Admin + Vendas + Lojista)
  wallclub-portais:
    build:
      context: .
      dockerfile: Dockerfile.portais
    container_name: wallclub-portais
    expose:
      - "8005"
    env_file:
      - ./services/django/.env
    environment:
      - DJANGO_SETTINGS_MODULE=wallclub.settings.portais
      - REDIS_HOST=wallclub-redis
      - REDIS_PORT=6379
      - CELERY_BROKER_URL=redis://wallclub-redis:6379/0
      - CELERY_RESULT_BACKEND=redis://wallclub-redis:6379/0
    volumes:
      - ./services/django/logs:/app/logs
      - ./services/django/media:/app/media
      - ./services/django/staticfiles:/app/staticfiles
      - ./services/core:/app/services/core:ro
    depends_on:
      - redis
    restart: unless-stopped
    mem_limit: 1g
    cpus: 1.0
    networks:
      - wallclub-network

  # Container 2: POS (Terminal POS)
  wallclub-pos:
    build:
      context: .
      dockerfile: Dockerfile.pos
    container_name: wallclub-pos
    expose:
      - "8006"
    env_file:
      - ./services/django/.env
    environment:
      - DJANGO_SETTINGS_MODULE=wallclub.settings.pos
      - REDIS_HOST=wallclub-redis
      - REDIS_PORT=6379
      - CELERY_BROKER_URL=redis://wallclub-redis:6379/0
      - CELERY_RESULT_BACKEND=redis://wallclub-redis:6379/0
      - RISK_ENGINE_URL=http://wallclub-riskengine:8008
    volumes:
      - ./services/django/logs:/app/logs
      - ./services/core:/app/services/core:ro
    depends_on:
      - redis
    restart: unless-stopped
    mem_limit: 512m
    cpus: 0.5
    networks:
      - wallclub-network

  # Container 3: APIs (Mobile + Checkout)
  wallclub-apis:
    build:
      context: .
      dockerfile: Dockerfile.apis
    container_name: wallclub-apis
    expose:
      - "8007"
    env_file:
      - ./services/django/.env
    environment:
      - DJANGO_SETTINGS_MODULE=wallclub.settings.apis
      - REDIS_HOST=wallclub-redis
      - REDIS_PORT=6379
      - CELERY_BROKER_URL=redis://wallclub-redis:6379/0
      - CELERY_RESULT_BACKEND=redis://wallclub-redis:6379/0
      - RISK_ENGINE_URL=http://wallclub-riskengine:8008
    volumes:
      - ./services/django/logs:/app/logs
      - ./services/django/media:/app/media
      - ./services/core:/app/services/core:ro
    depends_on:
      - redis
    restart: unless-stopped
    mem_limit: 1g
    cpus: 1.0
    networks:
      - wallclub-network

  # Container 4: Risk Engine (Antifraude)
  wallclub-riskengine:
    build:
      context: .
      dockerfile: Dockerfile.riskengine
    container_name: wallclub-riskengine
    command: gunicorn riskengine.wsgi:application --bind 0.0.0.0:8008 --workers 3 --timeout 120 --log-level=info --access-logfile=- --error-logfile=-
    expose:
      - "8008"
    env_file:
      - ./services/riskengine/.env
    environment:
      - REDIS_HOST=wallclub-redis
      - REDIS_PORT=6379
      - CELERY_BROKER_URL=redis://wallclub-redis:6379/0
      - CELERY_RESULT_BACKEND=redis://wallclub-redis:6379/0
      - CALLBACK_URL_PRINCIPAL=http://wallclub-apis:8007
    volumes:
      - ./services/riskengine/logs:/app/logs
      - ./services/core:/app/services/core:ro
    depends_on:
      - redis
    restart: unless-stopped
    mem_limit: 512m
    cpus: 0.5
    networks:
      - wallclub-network

  # Celery Worker - Portais
  wallclub-celery-worker-portais:
    build:
      context: .
      dockerfile: Dockerfile.portais
    container_name: wallclub-celery-worker-portais
    command: celery -A wallclub worker --loglevel=info --concurrency=2
    env_file:
      - ./services/django/.env
    environment:
      - DJANGO_SETTINGS_MODULE=wallclub.settings.portais
      - REDIS_HOST=wallclub-redis
      - REDIS_PORT=6379
      - CELERY_BROKER_URL=redis://wallclub-redis:6379/0
      - CELERY_RESULT_BACKEND=redis://wallclub-redis:6379/0
    volumes:
      - ./services/django/logs:/app/logs
      - ./services/core:/app/services/core:ro
    depends_on:
      - redis
      - wallclub-portais
    restart: unless-stopped
    mem_limit: 256m
    cpus: 0.25
    networks:
      - wallclub-network

  # Celery Worker - APIs
  wallclub-celery-worker-apis:
    build:
      context: .
      dockerfile: Dockerfile.apis
    container_name: wallclub-celery-worker-apis
    command: celery -A wallclub worker --loglevel=info --concurrency=4
    env_file:
      - ./services/django/.env
    environment:
      - DJANGO_SETTINGS_MODULE=wallclub.settings.apis
      - REDIS_HOST=wallclub-redis
      - REDIS_PORT=6379
      - CELERY_BROKER_URL=redis://wallclub-redis:6379/0
      - CELERY_RESULT_BACKEND=redis://wallclub-redis:6379/0
    volumes:
      - ./services/django/logs:/app/logs
      - ./services/core:/app/services/core:ro
    depends_on:
      - redis
      - wallclub-apis
    restart: unless-stopped
    mem_limit: 512m
    cpus: 0.5
    networks:
      - wallclub-network

  # Celery Beat - Scheduler
  wallclub-celery-beat:
    build:
      context: .
      dockerfile: Dockerfile.apis
    container_name: wallclub-celery-beat
    command: celery -A wallclub beat --loglevel=info
    env_file:
      - ./services/django/.env
    environment:
      - DJANGO_SETTINGS_MODULE=wallclub.settings.apis
      - REDIS_HOST=wallclub-redis
      - REDIS_PORT=6379
      - CELERY_BROKER_URL=redis://wallclub-redis:6379/0
      - CELERY_RESULT_BACKEND=redis://wallclub-redis:6379/0
    volumes:
      - ./services/django/logs:/app/logs
      - ./services/core:/app/services/core:ro
    depends_on:
      - redis
      - wallclub-celery-worker-apis
      - wallclub-celery-worker-portais
    restart: unless-stopped
    mem_limit: 128m
    cpus: 0.25
    networks:
      - wallclub-network

networks:
  wallclub-network:
    driver: bridge
    name: wallclub-network

volumes:
  redis_data:
